<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –°–±—Ä–æ—Å */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* –≠–∫—Ä–∞–Ω –ø–æ–≤–æ—Ä–æ—Ç–∞ */
    #rotateScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
      background: #111;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
    #mainInterface {
      display: none;
      height: 100vh;
      position: relative;
      background: #000;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
    #recordingIndicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(198, 40, 40, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .recordingDot {
      width: 10px;
      height: 10px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    /* –¢–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏ */
    #recordingTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #videoContainer {
      width: 100%;
      height: 100%;
      background: #000;
      position: relative;
    }

    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #000;
    }

    /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 40;
    }

    .control-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      min-width: 140px;
      transition: all 0.2s;
    }

    #startBtn { 
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #startBtn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #stopBtn { 
      background: linear-gradient(135deg, #c62828, #f44336);
      display: none;
    }

    .control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    /* –ü–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ */
    #tabsPanel {
      position: fixed;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 5px;
      border-radius: 0 15px 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease-out;
    }

    #tabsPanel.visible {
      left: 0;
    }

    .tab {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tab.active {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .tab-icon {
      font-size: 20px;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    .content-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .content-container:not(.active) {
      display: none;
    }

    .content-container.active {
      display: block;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ö–µ–º—ã */
    #fieldContainer {
      background: #0d47a1;
      position: relative;
      overflow: hidden;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    #fieldImageContainer {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã */
    #fieldImage {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #0d47a1;
    }

    /* –ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ */
    .marker-point {
      position: absolute;
      width: 28px;
      height: 28px;
      background: #FF0000;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      transform: translate(-50%, -50%);
      z-index: 100;
      cursor: move;
      transition: transform 0.1s;
      pointer-events: auto;
    }

    .marker-point.dragging {
      transform: translate(-50%, -50%) scale(1.4);
      z-index: 101;
      box-shadow: 0 0 30px rgba(255, 0, 0, 1);
    }

    /* –ú–∞—Ä–∫–µ—Ä—ã –≤–æ—Ä–æ—Ç */
    .goal-marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #00FF00;
      border-radius: 50%;
      border: 2px solid white;
      transform: translate(-50%, -50%);
      z-index: 99;
      pointer-events: none;
    }

    /* –õ–∏–Ω–∏–∏ –≤–æ—Ä–æ—Ç */
    .goal-line {
      position: absolute;
      height: 3px;
      background: rgba(255, 255, 0, 0.7);
      z-index: 98;
      pointer-events: none;
    }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ—Å–∫–µ */
    .shot-info {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 10px;
      border-radius: 8px;
      z-index: 200;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 140px;
      backdrop-filter: blur(5px);
    }

    /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞ —Å—Ö–µ–º–µ */
    #fieldInstruction {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ */
    #currentTabTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: none;
    }

    /* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã—Å—Ç—Ä–µ–ª–µ */
    #shotInfoPanel {
      position: absolute;
      top: 50px;
      right: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 15px;
      border-radius: 10px;
      display: none;
      z-index: 100;
      min-width: 150px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ */
    #choiceModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(5px);
    }

    #choiceModal.visible {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 30, 0.95);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 25px;
      color: white;
    }

    .choice-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .choice-btn {
      padding: 15px 25px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      color: white;
      flex: 1;
      transition: all 0.2s;
      min-width: 100px;
    }

    .choice-btn:active {
      transform: scale(0.95);
    }

    #goalBtn {
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #saveBtn {
      background: linear-gradient(135deg, #1565c0, #2196f3);
    }

    /* –û–≤–µ—Ä–ª–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ */
    #debugOverlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
      z-index: 1000;
      display: none;
      max-width: 200px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –ø–æ–≤–æ—Ä–æ—Ç–∞ -->
  <div id="rotateScreen">
    <svg viewBox="0 0 24 24" fill="white" width="60" height="60">
      <path d="M19 12h-1.5c-.82 0-1.5-.68-1.5-1.5V5.5C16 4.67 16.67 4 17.5 4H19c.83 0 1.5.67 1.5 1.5v3.5c0 .83-.67 1.5-1.5 1.5H1L1.01 21c0 1.1.89 2 2 2H21c1.1 0 2-.9 2-2L22.99 14H19zm-5.5-9H8.5V8h4V4zm6 14H2v2h18v-2z"/>
    </svg>
    <p style="margin-top: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div id="mainInterface">
    <!-- –ü–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div id="tabsPanel">
      <div class="tab active" data-tab="video">
        <div class="tab-icon">üé•</div>
      </div>
      <div class="tab" data-tab="field">
        <div class="tab-icon">üèí</div>
      </div>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ -->
    <div id="currentTabTitle">üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞</div>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã—Å—Ç—Ä–µ–ª–µ -->
    <div id="shotInfoPanel">
      <div style="font-weight: bold; margin-bottom: 10px; color: #4fc3f7;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—Ä–æ—Å–∫–∞</div>
      <div>–î–∏—Å—Ç–∞–Ω—Ü–∏—è: <span id="shotDistance">-</span> –º</div>
      <div>–£–≥–æ–ª –∞—Ç–∞–∫–∏: <span id="shotAngle">-</span>¬∞</div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ -->
    <div id="recordingIndicator">
      <div class="recordingDot"></div>
      <span>–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å</span>
    </div>

    <!-- –¢–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏ -->
    <div id="recordingTimer">00:00:00</div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ -->
    <div id="videoContainer" class="content-container active">
      <iframe id="videoFrame" allowfullscreen></iframe>
      
      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
      <div id="controls">
        <button id="startBtn" class="control-btn" disabled>–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="stopBtn" class="control-btn">–°—Ç–æ–ø</button>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ö–µ–º—ã -->
    <div id="fieldContainer" class="content-container">
      <div id="fieldImageContainer">
        <img id="fieldImage" src="1648780124_3-abrakadabra-fun-p-khokkeinoe-pole-sverkhu-10.jpg" alt="–•–æ–∫–∫–µ–π–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞">
      </div>
      <div id="fieldInstruction">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –±—Ä–æ—Å–∫–∞</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≥–æ–ª/—Å—ç–π–≤ -->
    <div id="choiceModal">
      <div class="modal-content">
        <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
        <div class="choice-buttons">
          <button id="goalBtn" class="choice-btn">–ì–æ–ª</button>
          <button id="saveBtn" class="choice-btn">–°—ç–π–≤</button>
        </div>
      </div>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="debugOverlay"></div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
    }

    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const rotateScreen = document.getElementById('rotateScreen');
    const mainInterface = document.getElementById('mainInterface');
    const tabsPanel = document.getElementById('tabsPanel');
    const videoContainer = document.getElementById('videoContainer');
    const fieldContainer = document.getElementById('fieldContainer');
    const fieldImage = document.getElementById('fieldImage');
    const fieldImageContainer = document.getElementById('fieldImageContainer');
    const videoFrame = document.getElementById('videoFrame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fieldInstruction = document.getElementById('fieldInstruction');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const recordingTimer = document.getElementById('recordingTimer');
    const choiceModal = document.getElementById('choiceModal');
    const goalBtn = document.getElementById('goalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const currentTabTitle = document.getElementById('currentTabTitle');
    const shotInfoPanel = document.getElementById('shotInfoPanel');
    const shotDistance = document.getElementById('shotDistance');
    const shotAngle = document.getElementById('shotAngle');
    const tabs = document.querySelectorAll('.tab');
    const debugOverlay = document.getElementById('debugOverlay');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let isRecording = false;
    let recordingStartTime = null;
    let timerInterval = null;
    let events = [];
    let currentTab = 'video';
    let currentMarker = null;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let markerStartX = 0;
    let markerStartY = 0;
    let recordingStopTime = 0;
    let videoCurrentTime = 0;
    let isVideoPaused = false;
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get('video');
    const matchDate = urlParams.get('date');
    const opponent = urlParams.get('opponent');
    const iceTime = urlParams.get('ice_time');

    // –ò—Å—Ö–æ–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ 2050√ó860)
    const ORIGINAL_IMAGE_SIZE = { width: 2050, height: 860 };
    
    const ORIGINAL_GOAL_COORDS = {
      leftGoal: {
        leftPost: { x: 188, y: 401 },    // –õ–µ–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–¥–ª—è –≤—Ä–∞—Ç–∞—Ä—è –≤ –ª–µ–≤—ã—Ö –≤–æ—Ä–æ—Ç–∞—Ö)
        rightPost: { x: 188, y: 458 },   // –ü—Ä–∞–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–¥–ª—è –≤—Ä–∞—Ç–∞—Ä—è –≤ –ª–µ–≤—ã—Ö –≤–æ—Ä–æ—Ç–∞—Ö)
        center: { x: 188, y: 429.5 }     // –¶–µ–Ω—Ç—Ä –ª–µ–≤—ã—Ö –≤–æ—Ä–æ—Ç
      },
      rightGoal: {
        leftPost: { x: 1861, y: 457 },   // –õ–µ–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–¥–ª—è –≤—Ä–∞—Ç–∞—Ä—è –≤ –ø—Ä–∞–≤—ã—Ö –≤–æ—Ä–æ—Ç–∞—Ö)
        rightPost: { x: 1861, y: 401 },  // –ü—Ä–∞–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–¥–ª—è –≤—Ä–∞—Ç–∞—Ä—è –≤ –ø—Ä–∞–≤—ã—Ö –≤–æ—Ä–æ—Ç–∞—Ö)
        center: { x: 1861, y: 429 }      // –¶–µ–Ω—Ç—Ä –ø—Ä–∞–≤—ã—Ö –≤–æ—Ä–æ—Ç
      }
    };

    // –†–∞–∑–º–µ—Ä—ã –≤–æ—Ä–æ—Ç –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∞—Ö
    const REAL_GOAL_WIDTH = 1.83;   // 1.83 –º–µ—Ç—Ä–∞ (—à–∏—Ä–∏–Ω–∞ –º–µ–∂–¥—É —à—Ç–∞–Ω–≥–∞–º–∏)
    const REAL_GOAL_HEIGHT = 1.22;  // 1.22 –º–µ—Ç—Ä–∞ (–≤—ã—Å–æ—Ç–∞ –æ—Ç –ª—å–¥–∞ –¥–æ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω—ã)
    const RINK_WIDTH_METERS = 30;   // ~30 –º–µ—Ç—Ä–æ–≤ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø–ª–æ—â–∞–¥–∫–∏ NHL)
    const RINK_LENGTH_METERS = 61;  // ~61 –º–µ—Ç—Ä (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–ª–æ—â–∞–¥–∫–∏ NHL)

    // –ú–∞—Å—à—Ç–∞–± –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    let scaleFactor = 1;
    let currentGoalCoords = {};
    let pixelsPerMeter = 0;
    let imageDisplayRect = { x: 0, y: 0, width: 0, height: 0 };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      loadVideo();
      setupEventListeners();
      initializeGoalCoordinates();
      checkOrientation();
      startBtn.disabled = false;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
    function loadVideo() {
      if (videoUrl) {
        let finalUrl = videoUrl;
        if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
          let videoId;
          if (videoUrl.includes('youtu.be/')) {
            videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
          } else {
            videoId = videoUrl.split('v=')[1]?.split('&')[0];
          }
          if (videoId) {
            finalUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&controls=1&enablejsapi=1`;
          }
        } else if (videoUrl.includes('vimeo.com')) {
          const vimeoId = videoUrl.split('/').pop();
          finalUrl = `https://player.vimeo.com/video/${vimeoId}?autoplay=0`;
        }
        videoFrame.src = finalUrl;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–æ—Ä–æ—Ç —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
    function initializeGoalCoordinates() {
      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      if (!fieldImage.complete) {
        fieldImage.onload = function() {
          setTimeout(updateGoalCoordinates, 100);
        };
      } else {
        updateGoalCoordinates();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–æ—Ä–æ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
    function updateGoalCoordinates() {
      const containerRect = fieldImageContainer.getBoundingClientRect();
      const imgRect = fieldImage.getBoundingClientRect();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—É—é –æ–±–ª–∞—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      imageDisplayRect = {
        x: imgRect.left - containerRect.left,
        y: imgRect.top - containerRect.top,
        width: imgRect.width,
        height: imgRect.height
      };
      
      // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
      scaleFactor = imgRect.width / ORIGINAL_IMAGE_SIZE.width;
      
      // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç
      currentGoalCoords = {
        leftGoal: scaleCoordinates(ORIGINAL_GOAL_COORDS.leftGoal),
        rightGoal: scaleCoordinates(ORIGINAL_GOAL_COORDS.rightGoal)
      };
      
      // –í—ã—á–∏—Å–ª—è–µ–º –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ –º–µ—Ç—Ä (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã—Å–æ—Ç—ã –≤–æ—Ä–æ—Ç)
      const originalGoalHeight = Math.abs(
        ORIGINAL_GOAL_COORDS.leftGoal.rightPost.y - ORIGINAL_GOAL_COORDS.leftGoal.leftPost.y
      );
      pixelsPerMeter = (originalGoalHeight * scaleFactor) / REAL_GOAL_HEIGHT;
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤–æ—Ä–æ—Ç
      drawGoalMarkers();
      
      // –û—Ç–ª–∞–¥–∫–∞
      updateDebugInfo();
    }

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    function scaleCoordinates(coords) {
      return {
        leftPost: {
          x: coords.leftPost.x * scaleFactor + imageDisplayRect.x,
          y: coords.leftPost.y * scaleFactor + imageDisplayRect.y
        },
        rightPost: {
          x: coords.rightPost.x * scaleFactor + imageDisplayRect.x,
          y: coords.rightPost.y * scaleFactor + imageDisplayRect.y
        },
        center: {
          x: coords.center.x * scaleFactor + imageDisplayRect.x,
          y: coords.center.y * scaleFactor + imageDisplayRect.y
        }
      };
    }

    // –û–±—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
    function unscaleCoordinates(x, y) {
      return {
        x: (x - imageDisplayRect.x) / scaleFactor,
        y: (y - imageDisplayRect.y) / scaleFactor
      };
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –≤ –∫–∞–∫–∏–µ –≤–æ—Ä–æ—Ç–∞ –±—å—é—Ç
    function determineActiveGoal(shootPoint) {
      const containerCenter = fieldImageContainer.getBoundingClientRect().width / 2;
      const relativeX = shootPoint.x - imageDisplayRect.x;
      
      // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –±—Ä–æ—Å–∫–∞ –≤ –ª–µ–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –±—å—é—Ç –≤ –ø—Ä–∞–≤—ã–µ –≤–æ—Ä–æ—Ç–∞
      if (relativeX < imageDisplayRect.width / 2) {
        return 'rightGoal';
      } else {
        return 'leftGoal';
      }
    }

    // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –≤ –º–µ—Ç—Ä–∞—Ö
    function calculateDistance(point1, point2) {
      const dx = point2.x - point1.x;
      const dy = point2.y - point1.y;
      const distancePixels = Math.sqrt(dx * dx + dy * dy);
      return distancePixels / pixelsPerMeter;
    }

    // –†–∞—Å—á–µ—Ç —É–≥–ª–∞ –∞—Ç–∞–∫–∏ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    function calculateAttackAngle(shootPoint, goalCoords) {
      const dx = shootPoint.x - goalCoords.center.x;
      const dy = shootPoint.y - goalCoords.center.y;
      
      // –£–≥–æ–ª –æ—Ç -90 –¥–æ +90 –≥—Ä–∞–¥—É—Å–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏ –≤–æ—Ä–æ—Ç
      let angleRad = Math.atan2(dx, Math.abs(dy));
      let angleDeg = angleRad * (180 / Math.PI);
      
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª (0¬∞ - –ø—Ä—è–º–æ–π –±—Ä–æ—Å–æ–∫ –≤ —Ü–µ–Ω—Ç—Ä, ¬±90¬∞ - —Å –∫—Ä–∞—è)
      return angleDeg;
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –≤–æ—Ä–æ—Ç
    function drawGoalMarkers() {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
      document.querySelectorAll('.goal-marker, .goal-line').forEach(el => el.remove());
      
      // –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –ª–µ–≤—ã—Ö –≤–æ—Ä–æ—Ç
      createGoalMarker(currentGoalCoords.leftGoal.center, 'left-center');
      createGoalMarker(currentGoalCoords.leftGoal.leftPost, 'left-left');
      createGoalMarker(currentGoalCoords.leftGoal.rightPost, 'left-right');
      
      // –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –ø—Ä–∞–≤—ã—Ö –≤–æ—Ä–æ—Ç
      createGoalMarker(currentGoalCoords.rightGoal.center, 'right-center');
      createGoalMarker(currentGoalCoords.rightGoal.leftPost, 'right-left');
      createGoalMarker(currentGoalCoords.rightGoal.rightPost, 'right-right');
      
      // –õ–∏–Ω–∏–∏ –≤–æ—Ä–æ—Ç
      createGoalLine(
        currentGoalCoords.leftGoal.leftPost,
        currentGoalCoords.leftGoal.rightPost,
        'left-goal-line'
      );
      
      createGoalLine(
        currentGoalCoords.rightGoal.leftPost,
        currentGoalCoords.rightGoal.rightPost,
        'right-goal-line'
      );
    }

    function createGoalMarker(coords, id) {
      const marker = document.createElement('div');
      marker.className = 'goal-marker';
      marker.id = id;
      marker.style.left = coords.x + 'px';
      marker.style.top = coords.y + 'px';
      fieldContainer.appendChild(marker);
    }

    function createGoalLine(start, end, id) {
      const line = document.createElement('div');
      line.className = 'goal-line';
      line.id = id;
      line.style.left = start.x + 'px';
      line.style.top = start.y + 'px';
      line.style.width = Math.abs(end.x - start.x) + 'px';
      line.style.height = Math.abs(end.y - start.y) + 'px';
      fieldContainer.appendChild(line);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      rotateScreen.style.display = isLandscape ? 'none' : 'flex';
      mainInterface.style.display = isLandscape ? 'block' : 'none';
      
      if (isLandscape) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
        setTimeout(updateGoalCoordinates, 100);
      }
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
    function updateTimer() {
      if (recordingStartTime) {
        const elapsed = Date.now() - recordingStartTime;
        recordingTimer.textContent = formatTime(elapsed);
      }
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
    function createMarker(x, y) {
      if (currentMarker) currentMarker.remove();
      
      currentMarker = document.createElement('div');
      currentMarker.className = 'marker-point';
      currentMarker.style.left = x + 'px';
      currentMarker.style.top = y + 'px';
      
      currentMarker.addEventListener('mousedown', startDrag);
      currentMarker.addEventListener('touchstart', startDragTouch);
      
      fieldContainer.appendChild(currentMarker);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      updateShotInfo(x, y);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
      setTimeout(() => {
        choiceModal.classList.add('visible');
      }, 300);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±—Ä–æ—Å–∫–µ
    function updateShotInfo(x, y) {
      const shootPoint = { x, y };
      const targetGoal = determineActiveGoal(shootPoint);
      const goalCoords = currentGoalCoords[targetGoal];
      
      const distance = calculateDistance(shootPoint, goalCoords.center);
      const angle = calculateAttackAngle(shootPoint, goalCoords);
      
      shotDistance.textContent = distance.toFixed(2);
      shotAngle.textContent = angle.toFixed(1);
      shotInfoPanel.style.display = 'block';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handleChoice
      window.lastShotData = {
        point: shootPoint,
        goal: targetGoal,
        distance: distance,
        angle: angle,
        originalCoords: unscaleCoordinates(x, y)
      };
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
    async function handleChoice(type) {
      choiceModal.classList.remove('visible');
      
      if (!currentMarker || !window.lastShotData) return;
      
      const shotData = window.lastShotData;
      const eventTime = Date.now() - recordingStartTime;
      
      const eventData = {
        type: type,
        timestamp: eventTime,
        videoTime: videoCurrentTime,
        shotParams: {
          distance: shotData.distance.toFixed(2),
          angle: shotData.angle.toFixed(1),
          goal: shotData.goal,
          originalX: shotData.originalCoords.x,
          originalY: shotData.originalCoords.y
        },
        matchInfo: {
          date: matchDate,
          opponent: opponent,
          iceTime: iceTime
        }
      };
      
      events.push(eventData);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç
      await sendDataToBot(eventData);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showNotification(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${type === 'goal' ? '–ì–æ–ª' : '–°—ç–π–≤'} –Ω–∞ ${shotData.distance.toFixed(1)}–º, —É–≥–æ–ª ${shotData.angle.toFixed(0)}¬∞`);
      
      // –û—á–∏—â–∞–µ–º
      if (currentMarker) {
        currentMarker.remove();
        currentMarker = null;
      }
      
      shotInfoPanel.style.display = 'none';
      switchTab('video');
      tabsPanel.classList.remove('visible');
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      isVideoPaused = false;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç
    async function sendDataToBot(eventData) {
      if (!tg) {
        console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', eventData);
        return;
      }
      
      try {
        const message = 
          `üéØ *–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ*\n` +
          `üìÖ ${matchDate} | ${opponent}\n` +
          `‚è±Ô∏è ${formatTime(eventData.timestamp)}\n` +
          `üéØ *${eventData.type === 'goal' ? '–ì–û–õ' : '–°–≠–ô–í'}*\n` +
          `üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${eventData.shotParams.distance} –º\n` +
          `üìê –£–≥–æ–ª –∞—Ç–∞–∫–∏: ${eventData.shotParams.angle}¬∞\n` +
          `üéØ –í–æ—Ä–æ—Ç–∞: ${eventData.shotParams.goal === 'leftGoal' ? '–õ–µ–≤—ã–µ' : '–ü—Ä–∞–≤—ã–µ'}`;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram WebApp
        tg.sendData(JSON.stringify({
          action: 'save_event',
          event: eventData
        }));
        
        // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ
        tg.showAlert(`–°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${eventData.type === 'goal' ? '–ì–æ–ª' : '–°—ç–π–≤'}`);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(text) {
      if (tg) {
        tg.showAlert(text);
      } else {
        alert(text);
      }
    }

    // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
    function startRecording() {
      if (isRecording) return;
      isRecording = true;
      recordingStartTime = Date.now();
      events = [];
      recordingIndicator.style.display = 'flex';
      recordingTimer.style.display = 'block';
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
      
      showNotification('‚è∫Ô∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞');
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
    function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      recordingStopTime = Date.now();
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      recordingIndicator.style.display = 'none';
      recordingTimer.style.display = 'none';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
      if (events.length > 0) {
        saveAllEvents();
      }
      
      showNotification(`‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –°–æ–±—ã—Ç–∏–π: ${events.length}`);
      
      tabsPanel.classList.add('visible');
      switchTab('field');
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
    async function saveAllEvents() {
      if (!tg) {
        console.log('–í—Å–µ —Å–æ–±—ã—Ç–∏—è:', events);
        return;
      }
      
      try {
        const summary = {
          action: 'save_summary',
          matchInfo: {
            date: matchDate,
            opponent: opponent,
            iceTime: iceTime,
            totalEvents: events.length,
            goals: events.filter(e => e.type === 'goal').length,
            saves: events.filter(e => e.type === 'save').length
          },
          events: events
        };
        
        tg.sendData(JSON.stringify(summary));
        tg.showAlert(`–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –°–æ–±—ã—Ç–∏–π: ${events.length}`);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
      }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function switchTab(tabName) {
      currentTab = tabName;
      tabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      if (tabName === 'video') {
        videoContainer.classList.add('active');
        fieldContainer.classList.remove('active');
        currentTabTitle.textContent = 'üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞';
        currentTabTitle.style.display = 'block';
      } else {
        videoContainer.classList.remove('active');
        fieldContainer.classList.add('active');
        currentTabTitle.textContent = 'üèí –°—Ö–µ–º–∞ –ø–æ–ª—è';
        currentTabTitle.style.display = 'block';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Å—Ö–µ–º–µ
    function handleFieldClick(e) {
      if (e.target.classList.contains('marker-point') || 
          e.target.classList.contains('goal-marker') ||
          e.target.classList.contains('goal-line')) {
        return;
      }
      
      const rect = fieldContainer.getBoundingClientRect();
      let x, y;
      
      if (e.type === 'click' || e.type === 'mousedown') {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
      } else if (e.type === 'touchstart') {
        const touch = e.touches[0];
        x = touch.clientX - rect.left;
        y = touch.clientY - rect.top;
      }
      
      createMarker(x, y);
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    function startDrag(e) {
      e.preventDefault();
      e.stopPropagation();
      isDragging = true;
      currentMarker.classList.add('dragging');
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
    }

    function startDragTouch(e) {
      e.preventDefault();
      e.stopPropagation();
      if (e.touches.length !== 1) return;
      isDragging = true;
      currentMarker.classList.add('dragging');
      const touch = e.touches[0];
      dragStartX = touch.clientX;
      dragStartY = touch.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('touchmove', dragTouch);
      document.addEventListener('touchend', stopDragTouch);
    }

    function drag(e) {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      updateShotInfo(newX, newY);
    }

    function dragTouch(e) {
      if (!isDragging || e.touches.length !== 1) return;
      const touch = e.touches[0];
      const deltaX = touch.clientX - dragStartX;
      const deltaY = touch.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      updateShotInfo(newX, newY);
    }

    function stopDrag() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
    }

    function stopDragTouch() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('touchmove', dragTouch);
      document.removeEventListener('touchend', stopDragTouch);
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è
      window.addEventListener('resize', checkOrientation);
      window.addEventListener('orientationchange', checkOrientation);
      
      // –ö–Ω–æ–ø–∫–∏
      startBtn.addEventListener('click', startRecording);
      stopBtn.addEventListener('click', stopRecording);
      
      // –í–∫–ª–∞–¥–∫–∏
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // –°—Ö–µ–º–∞
      fieldContainer.addEventListener('click', handleFieldClick);
      fieldContainer.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1) {
          e.preventDefault();
          const touch = e.touches[0];
          const rect = fieldContainer.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;
          createMarker(x, y);
        }
      });
      
      // –í—ã–±–æ—Ä
      goalBtn.addEventListener('click', () => handleChoice('goal'));
      saveBtn.addEventListener('click', () => handleChoice('save'));
      
      // –í–∏–¥–µ–æ
      window.addEventListener('message', handleVideoMessage);
      
      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      fieldImage.addEventListener('load', updateGoalCoordinates);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤–∏–¥–µ–æ
    function handleVideoMessage(event) {
      try {
        const data = JSON.parse(event.data);
        if (data.event === 'onReady') {
          startBtn.disabled = false;
        }
        if (data.info && data.info.currentTime !== undefined) {
          videoCurrentTime = data.info.currentTime;
        }
      } catch (e) {}
    }

    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    function updateDebugInfo() {
      if (debugOverlay.style.display === 'block') {
        debugOverlay.innerHTML = `
          –ú–∞—Å—à—Ç–∞–±: ${scaleFactor.toFixed(4)}<br>
          –ü–∏–∫—Å/–º–µ—Ç—Ä: ${pixelsPerMeter.toFixed(2)}<br>
          –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imageDisplayRect.width.toFixed(0)}√ó${imageDisplayRect.height.toFixed(0)}<br>
          –õ–µ–≤—ã–µ –≤–æ—Ä–æ—Ç–∞ X: ${currentGoalCoords.leftGoal?.center.x.toFixed(0)}<br>
          –ü—Ä–∞–≤—ã–µ –≤–æ—Ä–æ—Ç–∞ X: ${currentGoalCoords.rightGoal?.center.x.toFixed(0)}
        `;
      }
    }

    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    document.addEventListener('dblclick', function() {
      debugOverlay.style.display = debugOverlay.style.display === 'block' ? 'none' : 'block';
      updateDebugInfo();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
