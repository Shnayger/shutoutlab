<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –°–±—Ä–æ—Å */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* –≠–∫—Ä–∞–Ω –ø–æ–≤–æ—Ä–æ—Ç–∞ */
    #rotateScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
      background: #111;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
    #mainInterface {
      display: none;
      height: 100vh;
      position: relative;
      background: #000;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
    #recordingIndicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(198, 40, 40, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .recordingDot {
      width: 10px;
      height: 10px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    /* –¢–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏ */
    #recordingTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    #videoContainer {
      width: 100%;
      height: 100%;
      background: #000;
      position: relative;
    }

    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #000;
    }

    /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 40;
    }

    .control-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      min-width: 140px;
      transition: all 0.2s;
    }

    #startBtn { 
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #startBtn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #stopBtn { 
      background: linear-gradient(135deg, #c62828, #f44336);
      display: none;
    }

    .control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    /* –ü–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ */
    #tabsPanel {
      position: fixed;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 5px;
      border-radius: 0 15px 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease-out;
    }

    #tabsPanel.visible {
      left: 0;
    }

    .tab {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tab.active {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .tab-icon {
      font-size: 20px;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    .content-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .content-container:not(.active) {
      display: none;
    }

    .content-container.active {
      display: block;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ö–µ–º—ã */
    #fieldContainer {
      background: #0d47a1;
      position: relative;
      overflow: hidden;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    #fieldImageContainer {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã */
    #fieldImage {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #0d47a1;
    }

    /* –ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ */
    .marker-point {
      position: absolute;
      width: 28px;
      height: 28px;
      background: #FF0000;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      transform: translate(-50%, -50%);
      z-index: 100;
      cursor: move;
      transition: transform 0.1s;
      pointer-events: auto;
    }

    .marker-point.dragging {
      transform: translate(-50%, -50%) scale(1.4);
      z-index: 101;
      box-shadow: 0 0 30px rgba(255, 0, 0, 1);
    }

    /* –ú–∞—Ä–∫–µ—Ä—ã –≤–æ—Ä–æ—Ç */
    .goal-marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #00FF00;
      border-radius: 50%;
      border: 2px solid white;
      transform: translate(-50%, -50%);
      z-index: 99;
      pointer-events: none;
    }

    .goal-center-marker {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #FFFF00;
      border-radius: 50%;
      border: 2px solid #000;
      transform: translate(-50%, -50%);
      z-index: 99;
      pointer-events: none;
    }

    /* –õ–∏–Ω–∏–∏ –≤–æ—Ä–æ—Ç */
    .goal-line {
      position: absolute;
      height: 2px;
      background: rgba(255, 255, 0, 0.5);
      z-index: 98;
      pointer-events: none;
    }

    .goal-line.vertical {
      width: 2px;
      height: 20px;
    }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ—Å–∫–µ */
    .shot-info {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 12px;
      border-radius: 10px;
      z-index: 200;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 150px;
      backdrop-filter: blur(8px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .shot-info-header {
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 8px;
      font-size: 14px;
      text-align: center;
    }

    .shot-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .shot-info-label {
      color: #ccc;
    }

    .shot-info-value {
      font-weight: bold;
      color: #fff;
    }

    /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞ —Å—Ö–µ–º–µ */
    #fieldInstruction {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ */
    #currentTabTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: none;
    }

    /* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã—Å—Ç—Ä–µ–ª–µ */
    #shotInfoPanel {
      position: absolute;
      top: 50px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px;
      border-radius: 12px;
      display: none;
      z-index: 100;
      min-width: 160px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
    }

    #shotInfoPanel .panel-header {
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 10px;
      font-size: 15px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }

    #shotInfoPanel .panel-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 2px 0;
    }

    #shotInfoPanel .panel-label {
      color: #aaa;
      font-size: 13px;
    }

    #shotInfoPanel .panel-value {
      font-weight: bold;
      color: #fff;
      font-size: 14px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ */
    #choiceModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #choiceModal.visible {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 30, 0.97);
      padding: 30px 25px;
      border-radius: 20px;
      text-align: center;
      max-width: 320px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      animation: modalSlideUp 0.3s ease-out;
    }

    @keyframes modalSlideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 25px;
      color: white;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .choice-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .choice-btn {
      padding: 16px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      color: white;
      flex: 1;
      transition: all 0.2s;
      min-width: 110px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .choice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }

    .choice-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    #goalBtn {
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #saveBtn {
      background: linear-gradient(135deg, #1565c0, #2196f3);
    }

    /* –ü–ª–∞–≤–∞—é—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
    .floating-info {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      z-index: 90;
      pointer-events: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
    }

    /* –û–≤–µ—Ä–ª–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ */
    #debugOverlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 11px;
      z-index: 1000;
      display: none;
      max-width: 220px;
      font-family: 'Consolas', 'Monaco', monospace;
      line-height: 1.4;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
    .visual-guide {
      position: absolute;
      pointer-events: none;
      z-index: 80;
    }

    .distance-line {
      position: absolute;
      background: rgba(255, 255, 0, 0.3);
      height: 2px;
      transform-origin: 0 0;
      pointer-events: none;
      z-index: 80;
    }

    .angle-indicator {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 2px dashed rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      pointer-events: none;
      z-index: 80;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    @media (max-width: 768px) {
      .control-btn {
        padding: 12px 20px;
        font-size: 15px;
        min-width: 120px;
      }
      
      #shotInfoPanel {
        top: 40px;
        right: 8px;
        padding: 12px;
        min-width: 140px;
      }
      
      .modal-content {
        padding: 25px 20px;
      }
      
      .choice-btn {
        padding: 14px 20px;
        font-size: 15px;
        min-width: 90px;
      }
    }

    @media (max-width: 480px) {
      .control-btn {
        padding: 10px 16px;
        font-size: 14px;
        min-width: 100px;
      }
      
      #controls {
        gap: 10px;
      }
      
      #tabsPanel {
        padding: 10px 3px;
        gap: 8px;
      }
      
      .tab {
        width: 36px;
        height: 36px;
      }
      
      .tab-icon {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –ø–æ–≤–æ—Ä–æ—Ç–∞ -->
  <div id="rotateScreen">
    <svg viewBox="0 0 24 24" fill="white" width="60" height="60">
      <path d="M19 12h-1.5c-.82 0-1.5-.68-1.5-1.5V5.5C16 4.67 16.67 4 17.5 4H19c.83 0 1.5.67 1.5 1.5v3.5c0 .83-.67 1.5-1.5 1.5H1L1.01 21c0 1.1.89 2 2 2H21c1.1 0 2-.9 2-2L22.99 14H19zm-5.5-9H8.5V8h4V4zm6 14H2v2h18v-2z"/>
    </svg>
    <p style="margin-top: 20px; font-size: 16px; max-width: 300px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±–∑–æ—Ä–∞.</p>
    <p style="margin-top: 10px; font-size: 14px; color: #aaa; max-width: 300px;">–õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω—ã–π —Ä–µ–∂–∏–º –æ–±–µ—Å–ø–µ—á–∏—Ç –∫–æ–º—Ñ–æ—Ä—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É —Å –≤–∏–¥–µ–æ –∏ —Å—Ö–µ–º–æ–π.</p>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
  <div id="mainInterface">
    <!-- –ü–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div id="tabsPanel">
      <div class="tab active" data-tab="video">
        <div class="tab-icon">üé•</div>
      </div>
      <div class="tab" data-tab="field">
        <div class="tab-icon">üèí</div>
      </div>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏ -->
    <div id="currentTabTitle">üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞</div>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã—Å—Ç—Ä–µ–ª–µ -->
    <div id="shotInfoPanel">
      <div class="panel-header">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—Ä–æ—Å–∫–∞</div>
      <div class="panel-row">
        <span class="panel-label">–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span>
        <span class="panel-value" id="shotDistance">-</span>
      </div>
      <div class="panel-row">
        <span class="panel-label">–£–≥–æ–ª –∞—Ç–∞–∫–∏:</span>
        <span class="panel-value" id="shotAngle">-</span>
      </div>
      <div class="panel-row">
        <span class="panel-label">–í–æ—Ä–æ—Ç–∞:</span>
        <span class="panel-value" id="shotGoal">-</span>
      </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ -->
    <div id="recordingIndicator">
      <div class="recordingDot"></div>
      <span>–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å</span>
    </div>

    <!-- –¢–∞–π–º–µ—Ä –∑–∞–ø–∏—Å–∏ -->
    <div id="recordingTimer">00:00:00</div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ -->
    <div id="videoContainer" class="content-container active">
      <iframe id="videoFrame" allowfullscreen></iframe>
      
      <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
      <div id="controls">
        <button id="startBtn" class="control-btn" disabled>–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="stopBtn" class="control-btn">–°—Ç–æ–ø</button>
      </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ö–µ–º—ã -->
    <div id="fieldContainer" class="content-container">
      <div id="fieldImageContainer">
        <img id="fieldImage" src="1648780124_3-abrakadabra-fun-p-khokkeinoe-pole-sverkhu-10.jpg" alt="–•–æ–∫–∫–µ–π–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞">
      </div>
      <div id="fieldInstruction">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –±—Ä–æ—Å–∫–∞</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≥–æ–ª/—Å—ç–π–≤ -->
    <div id="choiceModal">
      <div class="modal-content">
        <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
        <div class="choice-buttons">
          <button id="goalBtn" class="choice-btn">–ì–æ–ª</button>
          <button id="saveBtn" class="choice-btn">–°—ç–π–≤</button>
        </div>
      </div>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="debugOverlay"></div>
  </div>

  <script>
    // ============================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEB APP
    // ============================
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      tg.enableClosingConfirmation();
      tg.setHeaderColor('#000000');
      tg.setBackgroundColor('#000000');
    }

    // ============================
    // –≠–õ–ï–ú–ï–ù–¢–´ –î–û–ú
    // ============================
    const rotateScreen = document.getElementById('rotateScreen');
    const mainInterface = document.getElementById('mainInterface');
    const tabsPanel = document.getElementById('tabsPanel');
    const videoContainer = document.getElementById('videoContainer');
    const fieldContainer = document.getElementById('fieldContainer');
    const fieldImage = document.getElementById('fieldImage');
    const fieldImageContainer = document.getElementById('fieldImageContainer');
    const videoFrame = document.getElementById('videoFrame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fieldInstruction = document.getElementById('fieldInstruction');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const recordingTimer = document.getElementById('recordingTimer');
    const choiceModal = document.getElementById('choiceModal');
    const goalBtn = document.getElementById('goalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const currentTabTitle = document.getElementById('currentTabTitle');
    const shotInfoPanel = document.getElementById('shotInfoPanel');
    const shotDistance = document.getElementById('shotDistance');
    const shotAngle = document.getElementById('shotAngle');
    const shotGoal = document.getElementById('shotGoal');
    const tabs = document.querySelectorAll('.tab');
    const debugOverlay = document.getElementById('debugOverlay');

    // ============================
    // –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø
    // ============================
    let isRecording = false;
    let recordingStartTime = null;
    let timerInterval = null;
    let events = [];
    let currentTab = 'video';
    let currentMarker = null;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let markerStartX = 0;
    let markerStartY = 0;
    let videoCurrentTime = 0;
    let isVideoPaused = false;
    let debugMode = false;
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get('video');
    const matchDate = urlParams.get('date') || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
    const opponent = urlParams.get('opponent') || '–ù–µ —É–∫–∞–∑–∞–Ω';
    const iceTime = urlParams.get('ice_time') || '0';

    // ============================
    // –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –†–ê–°–ß–ï–¢–û–í
    // ============================
    
    // –ò—Å—Ö–æ–¥–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const ORIGINAL_IMAGE_SIZE = { 
      width: 2050, 
      height: 860 
    };
    
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ (2050√ó860)
    const ORIGINAL_GOAL_COORDS = {
      // –õ–µ–≤—ã–µ –≤–æ—Ä–æ—Ç–∞ (–≤—Ä–∞—Ç–∞—Ä—å —Å–º–æ—Ç—Ä–∏—Ç –≤–ø—Ä–∞–≤–æ)
      leftGoal: {
        leftPost: { x: 188, y: 401 },    // –õ–µ–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–∞—Ç–∞—Ä—è)
        rightPost: { x: 188, y: 458 },   // –ü—Ä–∞–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–∞—Ç–∞—Ä—è)
        center: { x: 188, y: 429.5 }     // –¶–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç
      },
      // –ü—Ä–∞–≤—ã–µ –≤–æ—Ä–æ—Ç–∞ (–≤—Ä–∞—Ç–∞—Ä—å —Å–º–æ—Ç—Ä–∏—Ç –≤–ª–µ–≤–æ)
      rightGoal: {
        leftPost: { x: 1861, y: 457 },   // –õ–µ–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–∞—Ç–∞—Ä—è)
        rightPost: { x: 1861, y: 401 },  // –ü—Ä–∞–≤–∞—è —à—Ç–∞–Ω–≥–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–∞—Ç–∞—Ä—è)
        center: { x: 1861, y: 429 }      // –¶–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç
      }
    };

    // –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤–æ—Ä–æ—Ç –≤ –º–µ—Ç—Ä–∞—Ö
    const REAL_GOAL_WIDTH = 1.83;   // 1.83 –º–µ—Ç—Ä–∞ (—à–∏—Ä–∏–Ω–∞ –º–µ–∂–¥—É —à—Ç–∞–Ω–≥–∞–º–∏)
    const REAL_GOAL_HEIGHT = 1.22;  // 1.22 –º–µ—Ç—Ä–∞ (–≤—ã—Å–æ—Ç–∞ –æ—Ç –ª—å–¥–∞ –¥–æ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω—ã)

    // –ú–∞—Å—à—Ç–∞–± –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    let scaleFactor = 1;
    let currentGoalCoords = {};
    let pixelsPerMeter = 0;
    let imageDisplayRect = { x: 0, y: 0, width: 0, height: 0 };
    let lastShotData = null;

    // ============================
    // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
    // ============================

    /**
     * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     */
    function init() {
      console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===');
      console.log('–†–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞:', window.innerWidth, '√ó', window.innerHeight);
      console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL:', { videoUrl, matchDate, opponent, iceTime });
      
      loadVideo();
      setupEventListeners();
      initializeGoalCoordinates();
      checkOrientation();
      
      // –†–∞–∑—Ä–µ—à–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å" —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      setTimeout(() => {
        startBtn.disabled = false;
      }, 3000);
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –∏–∑ URL
     */
    function loadVideo() {
      if (!videoUrl) {
        console.warn('URL –≤–∏–¥–µ–æ –Ω–µ —É–∫–∞–∑–∞–Ω');
        videoFrame.style.display = 'none';
        return;
      }
      
      let finalUrl = videoUrl;
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ YouTube
      if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        let videoId;
        if (videoUrl.includes('youtu.be/')) {
          videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
        } else {
          videoId = videoUrl.split('v=')[1]?.split('&')[0];
        }
        
        if (videoId) {
          finalUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&controls=1&enablejsapi=1&playsinline=1`;
          console.log('YouTube video ID:', videoId);
        }
      }
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ Vimeo
      else if (videoUrl.includes('vimeo.com')) {
        const vimeoId = videoUrl.split('/').pop();
        finalUrl = `https://player.vimeo.com/video/${vimeoId}?autoplay=0&title=0&byline=0&portrait=0`;
      }
      
      videoFrame.src = finalUrl;
      console.log('URL –≤–∏–¥–µ–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', finalUrl);
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–æ—Ä–æ—Ç —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞
     */
    function initializeGoalCoordinates() {
      if (!fieldImage.complete) {
        fieldImage.onload = function() {
          setTimeout(() => {
            updateGoalCoordinates();
            drawGoalMarkers();
          }, 200);
        };
      } else {
        updateGoalCoordinates();
        drawGoalMarkers();
      }
      
      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      window.addEventListener('resize', () => {
        setTimeout(() => {
          updateGoalCoordinates();
          drawGoalMarkers();
        }, 100);
      });
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤–æ—Ä–æ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
     */
    function updateGoalCoordinates() {
      const containerRect = fieldImageContainer.getBoundingClientRect();
      const imgRect = fieldImage.getBoundingClientRect();
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      imageDisplayRect = {
        x: imgRect.left - containerRect.left,
        y: imgRect.top - containerRect.top,
        width: imgRect.width,
        height: imgRect.height
      };
      
      // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
      scaleFactor = imgRect.width / ORIGINAL_IMAGE_SIZE.width;
      
      // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç
      currentGoalCoords = {
        leftGoal: scaleCoordinates(ORIGINAL_GOAL_COORDS.leftGoal),
        rightGoal: scaleCoordinates(ORIGINAL_GOAL_COORDS.rightGoal)
      };
      
      // –í—ã—á–∏—Å–ª—è–µ–º –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ –º–µ—Ç—Ä
      const originalGoalHeight = 57; // 458 - 401 = 57 –ø–∏–∫—Å–µ–ª–µ–π
      pixelsPerMeter = (originalGoalHeight * scaleFactor) / REAL_GOAL_HEIGHT;
      
      if (debugMode) {
        updateDebugInfo();
      }
      
      console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', {
        scaleFactor: scaleFactor.toFixed(4),
        pixelsPerMeter: pixelsPerMeter.toFixed(2),
        imageDisplayRect
      });
    }

    /**
     * –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
     */
    function scaleCoordinates(coords) {
      return {
        leftPost: {
          x: coords.leftPost.x * scaleFactor + imageDisplayRect.x,
          y: coords.leftPost.y * scaleFactor + imageDisplayRect.y
        },
        rightPost: {
          x: coords.rightPost.x * scaleFactor + imageDisplayRect.x,
          y: coords.rightPost.y * scaleFactor + imageDisplayRect.y
        },
        center: {
          x: coords.center.x * scaleFactor + imageDisplayRect.x,
          y: coords.center.y * scaleFactor + imageDisplayRect.y
        }
      };
    }

    /**
     * –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –≤–æ—Ä–æ—Ç (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)
     */
    function drawGoalMarkers() {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
      document.querySelectorAll('.goal-marker, .goal-center-marker, .goal-line').forEach(el => el.remove());
      
      // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
      function createMarker(x, y, className, color) {
        const marker = document.createElement('div');
        marker.className = className;
        marker.style.left = x + 'px';
        marker.style.top = y + 'px';
        if (color) marker.style.backgroundColor = color;
        fieldContainer.appendChild(marker);
      }
      
      // –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –ª–µ–≤—ã—Ö –≤–æ—Ä–æ—Ç
      createMarker(currentGoalCoords.leftGoal.center.x, currentGoalCoords.leftGoal.center.y, 'goal-center-marker');
      createMarker(currentGoalCoords.leftGoal.leftPost.x, currentGoalCoords.leftGoal.leftPost.y, 'goal-marker');
      createMarker(currentGoalCoords.leftGoal.rightPost.x, currentGoalCoords.leftGoal.rightPost.y, 'goal-marker');
      
      // –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –ø—Ä–∞–≤—ã—Ö –≤–æ—Ä–æ—Ç
      createMarker(currentGoalCoords.rightGoal.center.x, currentGoalCoords.rightGoal.center.y, 'goal-center-marker');
      createMarker(currentGoalCoords.rightGoal.leftPost.x, currentGoalCoords.rightGoal.leftPost.y, 'goal-marker');
      createMarker(currentGoalCoords.rightGoal.rightPost.x, currentGoalCoords.rightGoal.rightPost.y, 'goal-marker');
      
      // –õ–∏–Ω–∏–∏ –≤–æ—Ä–æ—Ç
      createGoalLine(
        currentGoalCoords.leftGoal.leftPost,
        currentGoalCoords.leftGoal.rightPost,
        'left-goal-line'
      );
      
      createGoalLine(
        currentGoalCoords.rightGoal.leftPost,
        currentGoalCoords.rightGoal.rightPost,
        'right-goal-line'
      );
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–Ω–∏–∏ –≤–æ—Ä–æ—Ç
     */
    function createGoalLine(start, end, id) {
      const line = document.createElement('div');
      line.className = 'goal-line';
      line.id = id;
      line.style.left = start.x + 'px';
      line.style.top = start.y + 'px';
      line.style.width = Math.abs(end.x - start.x) + 'px';
      line.style.height = Math.abs(end.y - start.y) + 'px';
      fieldContainer.appendChild(line);
    }

    // ============================
    // –§–£–ù–ö–¶–ò–ò –†–ê–°–ß–ï–¢–ê –†–ê–°–°–¢–û–Ø–ù–ò–Ø –ò –£–ì–õ–ê
    // ============================

    /**
     * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –≤ –∫–∞–∫–∏–µ –≤–æ—Ä–æ—Ç–∞ –±—å—é—Ç
     */
    function determineActiveGoal(shootPoint) {
      // –¶–µ–Ω—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const imageCenterX = imageDisplayRect.x + imageDisplayRect.width / 2;
      
      // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –±—Ä–æ—Å–∫–∞ –ª–µ–≤–µ–µ —Ü–µ–Ω—Ç—Ä–∞ - –±—å—é—Ç –≤ –ø—Ä–∞–≤—ã–µ –≤–æ—Ä–æ—Ç–∞
      if (shootPoint.x < imageCenterX) {
        return 'rightGoal';
      } else {
        return 'leftGoal';
      }
    }

    /**
     * –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ —É–≥–ª–∞ –∞—Ç–∞–∫–∏
     * 
     * –£–≥–æ–ª —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ª–∏–Ω–∏–∏, –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–π –≤–æ—Ä–æ—Ç–∞–º:
     * 0¬∞ - –ø—Ä—è–º–æ–π –±—Ä–æ—Å–æ–∫ –≤ —Ü–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç
     * +90¬∞ - –±—Ä–æ—Å–æ–∫ —Å –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–∞—Ç–∞—Ä—è)
     * -90¬∞ - –±—Ä–æ—Å–æ–∫ —Å –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Ä–∞—Ç–∞—Ä—è)
     */
    function calculateDistanceAndAngle(shootPoint, goalCoords) {
      // –í–µ–∫—Ç–æ—Ä –æ—Ç —Ç–æ—á–∫–∏ –±—Ä–æ—Å–∫–∞ –∫ —Ü–µ–Ω—Ç—Ä—É –≤–æ—Ä–æ—Ç
      const dx = goalCoords.center.x - shootPoint.x;
      const dy = goalCoords.center.y - shootPoint.y;
      
      // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–≥–∏–ø–æ—Ç–µ–Ω—É–∑–∞)
      const distancePixels = Math.sqrt(dx * dx + dy * dy);
      const distanceMeters = distancePixels / pixelsPerMeter;
      
      // –†–∞—Å—á–µ—Ç —É–≥–ª–∞
      let angleRad = Math.atan2(dx, dy);
      let angleDeg = angleRad * (180 / Math.PI);
      
      // –î–ª—è –ø—Ä–∞–≤—ã—Ö –≤–æ—Ä–æ—Ç –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —É–≥–æ–ª –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
      if (goalCoords === currentGoalCoords.rightGoal) {
        angleDeg = -angleDeg;
      }
      
      return {
        distance: distanceMeters,
        angle: angleDeg
      };
    }

    // ============================
    // –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê –ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
    // ============================

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
     */
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      rotateScreen.style.display = isLandscape ? 'none' : 'flex';
      mainInterface.style.display = isLandscape ? 'block' : 'none';
      
      if (isLandscape) {
        setTimeout(() => {
          updateGoalCoordinates();
          drawGoalMarkers();
        }, 200);
      }
    }

    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
     */
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      } else {
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∑–∞–ø–∏—Å–∏
     */
    function updateTimer() {
      if (recordingStartTime) {
        const elapsed = Date.now() - recordingStartTime;
        recordingTimer.textContent = formatTime(elapsed);
      }
    }

    /**
     * –ü–∞—É–∑–∞ –≤–∏–¥–µ–æ YouTube
     */
    function pauseYouTubeVideo() {
      try {
        if (videoFrame.contentWindow) {
          videoFrame.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
          console.log('–í–∏–¥–µ–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–∞—É–∑—É');
        }
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑—É:', e);
      }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
     */
    function switchTab(tabName) {
      currentTab = tabName;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
      tabs.forEach(tab => {
        const tabData = tab.getAttribute('data-tab');
        if (tabData === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      if (tabName === 'video') {
        videoContainer.classList.add('active');
        fieldContainer.classList.remove('active');
        currentTabTitle.textContent = 'üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞';
        currentTabTitle.style.display = 'block';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—É–∑—ã
        isVideoPaused = false;
      } else {
        videoContainer.classList.remove('active');
        fieldContainer.classList.add('active');
        currentTabTitle.textContent = 'üèí –°—Ö–µ–º–∞ –ø–æ–ª—è';
        currentTabTitle.style.display = 'block';
        
        // –°—Ç–∞–≤–∏–º –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —Å—Ö–µ–º—É
        pauseYouTubeVideo();
        isVideoPaused = true;
      }
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ —Å—Ö–µ–º–µ
     */
    function createMarker(x, y) {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (currentMarker) {
        currentMarker.remove();
        currentMarker = null;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
      currentMarker = document.createElement('div');
      currentMarker.className = 'marker-point';
      currentMarker.style.left = x + 'px';
      currentMarker.style.top = y + 'px';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      currentMarker.addEventListener('mousedown', startDrag);
      currentMarker.addEventListener('touchstart', startDragTouch);
      
      fieldContainer.appendChild(currentMarker);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ—Å–∫–µ
      updateShotInfo(x, y);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
      setTimeout(() => {
        choiceModal.classList.add('visible');
      }, 300);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±—Ä–æ—Å–∫–µ
     */
    function updateShotInfo(x, y) {
      const shootPoint = { x, y };
      const targetGoalName = determineActiveGoal(shootPoint);
      const goalCoords = currentGoalCoords[targetGoalName];
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
      if (!goalCoords || !goalCoords.center || !pixelsPerMeter) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç –∏–ª–∏ –º–∞—Å—à—Ç–∞–±');
        shotDistance.textContent = '–û—à–∏–±–∫–∞';
        shotAngle.textContent = '–û—à–∏–±–∫–∞';
        shotGoal.textContent = '–û—à–∏–±–∫–∞';
        return;
      }
      
      // –†–∞—Å—á–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      const result = calculateDistanceAndAngle(shootPoint, goalCoords);
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
      if (!isFinite(result.distance) || !isFinite(result.angle)) {
        console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:', result);
        shotDistance.textContent = '–û—à–∏–±–∫–∞';
        shotAngle.textContent = '–û—à–∏–±–∫–∞';
        shotGoal.textContent = '–û—à–∏–±–∫–∞';
        return;
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      shotDistance.textContent = result.distance.toFixed(2) + ' –º';
      shotAngle.textContent = result.angle.toFixed(1) + '¬∞';
      shotGoal.textContent = targetGoalName === 'leftGoal' ? '–õ–µ–≤—ã–µ' : '–ü—Ä–∞–≤—ã–µ';
      shotInfoPanel.style.display = 'block';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞
      lastShotData = {
        point: shootPoint,
        goal: targetGoalName,
        distance: result.distance,
        angle: result.angle
      };
    }

    // ============================
    // –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –ò –í–´–ë–û–†–ê
    // ============================

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è (–≥–æ–ª/—Å—ç–π–≤)
     */
    async function handleChoice(type) {
      // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      choiceModal.classList.remove('visible');
      shotInfoPanel.style.display = 'none';
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
      if (!currentMarker || !lastShotData) {
        console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–æ—Å–∫–µ');
        return;
      }
      
      // –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
      const eventTime = Date.now() - recordingStartTime;
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
      const eventData = {
        type: type,
        timestamp: eventTime,
        videoTime: videoCurrentTime,
        shotParams: {
          distance: lastShotData.distance.toFixed(2),
          angle: lastShotData.angle.toFixed(1),
          goal: lastShotData.goal,
          goalName: lastShotData.goal === 'leftGoal' ? '–õ–µ–≤—ã–µ' : '–ü—Ä–∞–≤—ã–µ'
        },
        matchInfo: {
          date: matchDate,
          opponent: opponent,
          iceTime: iceTime
        }
      };
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
      events.push(eventData);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –±–æ—Ç
      if (tg) {
        try {
          tg.sendData(JSON.stringify({
            action: 'save_event',
            event: eventData
          }));
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç:', error);
        }
      }
      
      // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
      currentMarker.remove();
      currentMarker = null;
      lastShotData = null;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫
      tabsPanel.classList.remove('visible');
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∏–¥–µ–æ
      switchTab('video');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—É–∑—ã
      isVideoPaused = false;
    }

    /**
     * –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
     */
    function startRecording() {
      if (isRecording) return;
      
      isRecording = true;
      recordingStartTime = Date.now();
      events = [];
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
      recordingIndicator.style.display = 'flex';
      recordingTimer.style.display = 'block';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
      
      console.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞');
    }

    /**
     * –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
     */
    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
      recordingIndicator.style.display = 'none';
      recordingTimer.style.display = 'none';
      
      // –°—Ç–∞–≤–∏–º –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑—É
      pauseYouTubeVideo();
      isVideoPaused = true;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫
      tabsPanel.classList.add('visible');
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å—Ö–µ–º—É
      switchTab('field');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      startBtn.style.display = 'none';
      stopBtn.style.display = 'none';
      
      console.log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –°–æ–±—ã—Ç–∏–π:', events.length);
    }

    // ============================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø
    // ============================

    function startDrag(e) {
      e.preventDefault();
      e.stopPropagation();
      isDragging = true;
      currentMarker.classList.add('dragging');
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
    }

    function startDragTouch(e) {
      e.preventDefault();
      e.stopPropagation();
      if (e.touches.length !== 1) return;
      isDragging = true;
      currentMarker.classList.add('dragging');
      const touch = e.touches[0];
      dragStartX = touch.clientX;
      dragStartY = touch.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('touchmove', dragTouch);
      document.addEventListener('touchend', stopDragTouch);
    }

    function drag(e) {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      updateShotInfo(newX, newY);
    }

    function dragTouch(e) {
      if (!isDragging || e.touches.length !== 1) return;
      const touch = e.touches[0];
      const deltaX = touch.clientX - dragStartX;
      const deltaY = touch.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      updateShotInfo(newX, newY);
    }

    function stopDrag() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
    }

    function stopDragTouch() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('touchmove', dragTouch);
      document.removeEventListener('touchend', stopDragTouch);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Å—Ö–µ–º–µ
     */
    function handleFieldClick(e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –º–∞—Ä–∫–µ—Ä—É
      if (e.target.classList.contains('marker-point') || 
          e.target.classList.contains('goal-marker') ||
          e.target.classList.contains('goal-center-marker') ||
          e.target.classList.contains('goal-line')) {
        return;
      }
      
      const rect = fieldContainer.getBoundingClientRect();
      let x, y;
      
      if (e.type === 'click' || e.type === 'mousedown') {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
      } else if (e.type === 'touchstart') {
        const touch = e.touches[0];
        x = touch.clientX - rect.left;
        y = touch.clientY - rect.top;
        e.preventDefault();
      }
      
      createMarker(x, y);
    }

    // ============================
    // –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô
    // ============================

    function setupEventListeners() {
      // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      window.addEventListener('resize', checkOrientation);
      window.addEventListener('orientationchange', checkOrientation);
      
      // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      startBtn.addEventListener('click', startRecording);
      stopBtn.addEventListener('click', stopRecording);
      
      // –í–∫–ª–∞–¥–∫–∏
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // –°—Ö–µ–º–∞
      fieldContainer.addEventListener('click', handleFieldClick);
      fieldContainer.addEventListener('touchstart', handleFieldClick, { passive: false });
      
      // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
      goalBtn.addEventListener('click', () => handleChoice('goal'));
      saveBtn.addEventListener('click', () => handleChoice('save'));
      
      // –í–∏–¥–µ–æ
      window.addEventListener('message', handleVideoMessage);
      
      // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      fieldImage.addEventListener('load', () => {
        console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ö–µ–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
        updateGoalCoordinates();
        drawGoalMarkers();
      });
      
      // –û—Ç–ª–∞–¥–∫–∞ (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)
      document.addEventListener('dblclick', toggleDebugMode);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤–∏–¥–µ–æ
     */
    function handleVideoMessage(event) {
      try {
        const data = JSON.parse(event.data);
        
        if (data.event === 'onReady') {
          startBtn.disabled = false;
          console.log('–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
        }
        
        if (data.info && data.info.currentTime !== undefined) {
          videoCurrentTime = data.info.currentTime;
        }
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ JSON
      }
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–ª–∞–¥–∫–∏
     */
    function toggleDebugMode() {
      debugMode = !debugMode;
      debugOverlay.style.display = debugMode ? 'block' : 'none';
      updateDebugInfo();
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
     */
    function updateDebugInfo() {
      if (!debugMode) return;
      
      debugOverlay.innerHTML = `
        <strong>–û—Ç–ª–∞–¥–∫–∞:</strong><br>
        –≠–∫—Ä–∞–Ω: ${window.innerWidth}√ó${window.innerHeight}<br>
        –ú–∞—Å—à—Ç–∞–±: ${scaleFactor.toFixed(4)}<br>
        –ü–∏–∫—Å/–º–µ—Ç—Ä: ${pixelsPerMeter.toFixed(2)}<br>
        –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imageDisplayRect.width.toFixed(0)}√ó${imageDisplayRect.height.toFixed(0)}<br>
        –õ–µ–≤—ã–µ –≤–æ—Ä–æ—Ç–∞: (${currentGoalCoords.leftGoal?.center.x.toFixed(0)}, ${currentGoalCoords.leftGoal?.center.y.toFixed(0)})<br>
        –ü—Ä–∞–≤—ã–µ –≤–æ—Ä–æ—Ç–∞: (${currentGoalCoords.rightGoal?.center.x.toFixed(0)}, ${currentGoalCoords.rightGoal?.center.y.toFixed(0)})<br>
        –°–æ–±—ã—Ç–∏–π: ${events.length}<br>
        –ó–∞–ø–∏—Å—å: ${isRecording ? '–î–ê' : '–Ω–µ—Ç'}
      `;
    }

    // ============================
    // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // ============================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
