<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Анализ матча</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Сброс */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    /* Экран поворота */
    #rotateScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
      background: #111;
    }

    /* Основной интерфейс */
    #mainInterface {
      display: none;
      height: 100vh;
      position: relative;
    }

    /* Индикатор записи */
    #recordingIndicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #c62828;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 15;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .recordingDot {
      width: 10px;
      height: 10px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    /* Таймер записи */
    #recordingTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 15;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Видео контейнер */
    #videoContainer {
      width: 100%;
      height: 100%;
      background: #000;
    }

    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Управление */
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 10;
    }

    .control-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      min-width: 140px;
      transition: all 0.2s;
    }

    #startBtn { 
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #startBtn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #stopBtn { 
      background: linear-gradient(135deg, #c62828, #f44336);
      display: none;
    }

    .control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    /* Поле для разметки (КХЛ) */
    #fieldOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a237e;
      display: none;
      z-index: 20;
    }

    #hockeyField {
      width: 100%;
      height: 100%;
    }

    /* Зоны для клика */
    .clickable-zone {
      cursor: pointer;
      transition: all 0.2s;
    }

    .clickable-zone:hover {
      opacity: 0.8;
    }

    .highlight {
      fill: rgba(255, 255, 255, 0.4) !important;
      stroke: white !important;
      stroke-width: 3px !important;
    }
  </style>
</head>
<body>
  <!-- Экран поворота -->
  <div id="rotateScreen">
    <svg viewBox="0 0 24 24" fill="white" width="60" height="60">
      <path d="M19 12h-1.5c-.82 0-1.5-.68-1.5-1.5V5.5C16 4.67 16.67 4 17.5 4H19c.83 0 1.5.67 1.5 1.5v3.5c0 .83-.67 1.5-1.5 1.5H1L1.01 21c0 1.1.89 2 2 2H21c1.1 0 2-.9 2-2L22.99 14H19zm-5.5-9H8.5V8h4V4zm6 14H2v2h18v-2z"/>
    </svg>
    <p style="margin-top: 20px;">Пожалуйста, поверните устройство в горизонтальное положение.</p>
  </div>

  <!-- Основной интерфейс -->
  <div id="mainInterface">
    <!-- Индикатор записи -->
    <div id="recordingIndicator">
      <div class="recordingDot"></div>
      <span>Идет запись</span>
    </div>

    <!-- Таймер записи -->
    <div id="recordingTimer">00:00:00</div>

    <!-- Видео -->
    <div id="videoContainer">
      <iframe id="videoFrame" allowfullscreen></iframe>
    </div>

    <!-- Управление -->
    <div id="controls">
      <button id="startBtn" class="control-btn" disabled>Начать запись</button>
      <button id="stopBtn" class="control-btn">Стоп</button>
    </div>

    <!-- Поле для разметки (КХЛ) -->
    <div id="fieldOverlay">
      <svg id="hockeyField" viewBox="0 0 200 85" xmlns="http://www.w3.org/2000/svg">
        <!-- Лёд -->
        <rect width="200" height="85" fill="#87CEEB"/>
        
        <!-- Борта (красные) -->
        <rect x="0" y="0" width="200" height="85" fill="none" stroke="#FF0000" stroke-width="0.5"/>
        
        <!-- Центральная красная линия -->
        <line x1="100" y1="0" x2="100" y2="85" stroke="#FF0000" stroke-width="1"/>
        
        <!-- Центральный круг -->
        <circle cx="100" cy="42.5" r="15" fill="none" stroke="#FF0000" stroke-width="1"/>
        <circle cx="100" cy="42.5" r="0.5" fill="#FF0000"/>
        
        <!-- Синие линии -->
        <rect x="25" y="0" width="1" height="85" fill="#0000FF"/>
        <rect x="174" y="0" width="1" height="85" fill="#0000FF"/>
        
        <!-- Зоны ворот -->
        <rect x="0" y="30" width="11" height="25" fill="none" stroke="#000000" stroke-width="1"/>
        <rect x="189" y="30" width="11" height="25" fill="none" stroke="#000000" stroke-width="1"/>
        
        <!-- Круги вбрасывания -->
        <!-- Центральный -->
        <circle cx="100" cy="42.5" r="3" fill="none" stroke="#FF0000" stroke-width="0.5"/>
        
        <!-- В зонах -->
        <circle cx="25" cy="42.5" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-center-left"/>
        <circle cx="175" cy="42.5" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-center-right"/>
        
        <!-- В зоне защиты слева -->
        <circle cx="25" cy="20" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-def-left-top"/>
        <circle cx="25" cy="65" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-def-left-bottom"/>
        
        <!-- В зоне защиты справа -->
        <circle cx="175" cy="20" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-def-right-top"/>
        <circle cx="175" cy="65" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-def-right-bottom"/>
        
        <!-- В зоне атаки слева -->
        <circle cx="60" cy="20" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-att-left-top"/>
        <circle cx="60" cy="65" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-att-left-bottom"/>
        
        <!-- В зоне атаки справа -->
        <circle cx="140" cy="20" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-att-right-top"/>
        <circle cx="140" cy="65" r="3" fill="none" stroke="#FF0000" stroke-width="0.5" class="clickable-zone" id="faceoff-att-right-bottom"/>
        
        <!-- Зоны для кликов (невидимые прямоугольники для удобства) -->
        <!-- Левая зона защиты -->
        <rect x="0" y="0" width="50" height="85" fill="transparent" class="clickable-zone" id="zone-defense-left"/>
        
        <!-- Правая зона защиты -->
        <rect x="150" y="0" width="50" height="85" fill="transparent" class="clickable-zone" id="zone-defense-right"/>
        
        <!-- Левая зона атаки -->
        <rect x="50" y="0" width="50" height="85" fill="transparent" class="clickable-zone" id="zone-attack-left"/>
        
        <!-- Правая зона атаки -->
        <rect x="100" y="0" width="50" height="85" fill="transparent" class="clickable-zone" id="zone-attack-right"/>
        
        <!-- Центральная зона -->
        <rect x="75" y="0" width="50" height="85" fill="transparent" class="clickable-zone" id="zone-center"/>
        
        <!-- Левые ворота -->
        <rect x="0" y="30" width="11" height="25" fill="transparent" class="clickable-zone" id="goal-left"/>
        
        <!-- Правые ворота -->
        <rect x="189" y="30" width="11" height="25" fill="transparent" class="clickable-zone" id="goal-right"/>
        
        <!-- Точки вбрасывания (белые) -->
        <circle cx="100" cy="42.5" r="0.5" fill="white"/>
        <circle cx="25" cy="42.5" r="0.5" fill="white"/>
        <circle cx="175" cy="42.5" r="0.5" fill="white"/>
        <circle cx="25" cy="20" r="0.5" fill="white"/>
        <circle cx="25" cy="65" r="0.5" fill="white"/>
        <circle cx="175" cy="20" r="0.5" fill="white"/>
        <circle cx="175" cy="65" r="0.5" fill="white"/>
        <circle cx="60" cy="20" r="0.5" fill="white"/>
        <circle cx="60" cy="65" r="0.5" fill="white"/>
        <circle cx="140" cy="20" r="0.5" fill="white"/>
        <circle cx="140" cy="65" r="0.5" fill="white"/>
      </svg>
    </div>
  </div>

  <script>
    // Инициализация Telegram Web App
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }

    // Элементы
    const rotateScreen = document.getElementById('rotateScreen');
    const mainInterface = document.getElementById('mainInterface');
    const videoFrame = document.getElementById('videoFrame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fieldOverlay = document.getElementById('fieldOverlay');
    const hockeyField = document.getElementById('hockeyField');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const recordingTimer = document.getElementById('recordingTimer');

    // Переменные состояния
    let isRecording = false;
    let recordingStartTime = null;
    let timerInterval = null;
    let events = [];

    // Параметры из URL
    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get('video');
    const date = urlParams.get('date');
    const opponent = urlParams.get('opponent');
    const iceTime = urlParams.get('ice_time');

    // Загружаем видео
    if (videoUrl) {
      let finalUrl = videoUrl;
      
      // YouTube
      if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        let videoId;
        if (videoUrl.includes('youtu.be/')) {
          videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
        } else {
          videoId = videoUrl.split('v=')[1]?.split('&')[0];
        }
        if (videoId) {
          finalUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&controls=1&enablejsapi=1`;
        }
      }
      // Vimeo
      else if (videoUrl.includes('vimeo.com')) {
        const vimeoId = videoUrl.split('/').pop();
        finalUrl = `https://player.vimeo.com/video/${vimeoId}?autoplay=0`;
      }
      
      videoFrame.src = finalUrl;
    }

    // Проверка ориентации
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      rotateScreen.style.display = isLandscape ? 'none' : 'flex';
      mainInterface.style.display = isLandscape ? 'block' : 'none';
    }

    window.addEventListener('resize', checkOrientation);
    checkOrientation();

    // Форматирование времени
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Обновление таймера
    function updateTimer() {
      if (recordingStartTime) {
        const elapsed = Date.now() - recordingStartTime;
        recordingTimer.textContent = formatTime(elapsed);
      }
    }

    // Начало записи
    function startRecording() {
      if (isRecording) return;
      
      isRecording = true;
      recordingStartTime = Date.now();
      events = [];
      
      // Показываем индикаторы
      recordingIndicator.style.display = 'flex';
      recordingTimer.style.display = 'block';
      
      // Обновляем кнопки
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      
      // Запускаем таймер
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
      
      console.log('Запись начата в', new Date().toLocaleTimeString());
    }

    // Остановка записи
    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      
      // Останавливаем видео
      if (videoFrame.contentWindow) {
        try {
          videoFrame.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        } catch (e) {
          console.log('Не удалось остановить видео');
        }
      }
      
      // Останавливаем таймер
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      // Скрываем индикаторы
      recordingIndicator.style.display = 'none';
      recordingTimer.style.display = 'none';
      
      // Показываем поле
      fieldOverlay.style.display = 'block';
      
      console.log('Запись остановлена. Событий:', events.length);
      console.log('Все события:', events);
    }

    // Обработчики кнопок
    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    // Проверяем, когда видео готово (для YouTube)
    function checkVideoReady() {
      // Для YouTube можно слушать сообщения
      window.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.event === 'onReady') {
            startBtn.disabled = false;
          }
        } catch (e) {
          // Не JSON сообщение
        }
      });
      
      // Общий таймаут
      setTimeout(() => {
        startBtn.disabled = false;
      }, 3000);
    }

    // Запускаем проверку
    checkVideoReady();

    // Клики по полю
    const zones = {
      // Лицевые вбрасывания
      'faceoff-center-left': 'Лицевое вбрасывание (центр, слева)',
      'faceoff-center-right': 'Лицевое вбрасывание (центр, справа)',
      'faceoff-def-left-top': 'Лицевое вбрасывание (зона защиты, слева, верх)',
      'faceoff-def-left-bottom': 'Лицевое вбрасывание (зона защиты, слева, низ)',
      'faceoff-def-right-top': 'Лицевое вбрасывание (зона защиты, справа, верх)',
      'faceoff-def-right-bottom': 'Лицевое вбрасывание (зона защиты, справа, низ)',
      'faceoff-att-left-top': 'Лицевое вбрасывание (зона атаки, слева, верх)',
      'faceoff-att-left-bottom': 'Лицевое вбрасывание (зона атаки, слева, низ)',
      'faceoff-att-right-top': 'Лицевое вбрасывание (зона атаки, справа, верх)',
      'faceoff-att-right-bottom': 'Лицевое вбрасывание (зона атаки, справа, низ)',
      
      // Зоны
      'zone-defense-left': 'Зона защиты (слева)',
      'zone-defense-right': 'Зона защиты (справа)',
      'zone-attack-left': 'Зона атаки (слева)',
      'zone-attack-right': 'Зона атаки (справа)',
      'zone-center': 'Центральная зона',
      
      // Ворота
      'goal-left': 'Ворота (слева)',
      'goal-right': 'Ворота (справа)',
    };

    hockeyField.addEventListener('click', (e) => {
      if (!isRecording) return;
      
      const target = e.target;
      const id = target.id;
      
      if (zones[id]) {
        // Подсветка
        target.classList.add('highlight');
        
        // Данные события
        const eventData = {
          zone_id: id,
          zone_name: zones[id],
          timestamp: Date.now() - recordingStartTime,
          video_time: videoFrame.currentTime || 0,
          match_date: date,
          opponent: opponent,
          ice_time: iceTime
        };
        
        events.push(eventData);
        
        // Отправляем в Telegram
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.sendData(JSON.stringify(eventData));
        }
        
        // Убираем подсветку
        setTimeout(() => {
          target.classList.remove('highlight');
        }, 800);
        
        console.log('Записано событие:', eventData);
      }
    });
  </script>
</body>
</html>
