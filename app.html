<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    #rotateScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
      background: #111;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    #mainInterface {
      display: none;
      height: 100vh;
      position: relative;
      background: #000;
    }

    #recordingIndicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(198, 40, 40, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .recordingDot {
      width: 10px;
      height: 10px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    #recordingTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #videoContainer {
      width: 100%;
      height: 100%;
      background: #000;
      position: relative;
      display: none;
    }

    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #000;
    }

    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 40;
    }

    .control-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      min-width: 140px;
      transition: all 0.2s;
    }

    #startBtn { 
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #startBtn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #stopBtn { 
      background: linear-gradient(135deg, #c62828, #f44336);
      display: none;
    }

    .control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    #tabsPanel {
      position: fixed;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 5px;
      border-radius: 0 15px 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease-out;
    }

    #tabsPanel.visible {
      left: 0;
    }

    .tab {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tab.active {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .tab-icon {
      font-size: 20px;
    }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
#fieldContainer {
  width: 100%;
  height: 100%;
  background: #000;
  position: relative;
  overflow: hidden;
  display: none;
}

#fieldImage {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: auto;
  height: auto;
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  display: block;
  pointer-events: auto;
}

/* –î–ª—è –ü–ö –∏ –ø–ª–∞–Ω—à–µ—Ç–æ–≤ (—à–∏—Ä–æ–∫–∏–µ —ç–∫—Ä–∞–Ω—ã) */
@media (min-width: 768px) {
  #fieldImage {
    max-width: 100vw;
    max-height: 100vh;
  }
}

/* –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (—É–∑–∫–∏–µ —ç–∫—Ä–∞–Ω—ã) */
@media (max-width: 767px) {
  #fieldImage {
    max-width: 100%;
    max-height: 150%;
  }
}
    
    .marker-point {
      position: absolute;
      width: 28px;
      height: 28px;
      background: #FF0000;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      transform: translate(-50%, -50%);
      z-index: 30;
      cursor: move;
      transition: transform 0.1s;
    }

    .marker-point.dragging {
      transform: translate(-50%, -50%) scale(1.4);
      z-index: 31;
      box-shadow: 0 0 30px rgba(255, 0, 0, 1);
    }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(5px);
    }

    .modal.visible {
      display: flex;
    }

    #choiceModal, #saveTypeModal {
      /* –ù–∞—Å–ª–µ–¥—É—é—Ç —Å—Ç–∏–ª–∏ –æ—Ç .modal */
    }

           .modal-content {
      background: rgba(30, 30, 30, 0.95);
      padding: 30px 20px;
      border-radius: 20px;
      text-align: center;
      max-width: 350px;
      width: 95%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-sizing: border-box;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 25px;
      color: white;
    }

          .choice-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
    }

            .choice-btn {
      padding: 15px 10px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      color: white;
      flex: 1 1 auto;
      transition: all 0.2s;
      min-width: 90px;
      white-space: nowrap;
      text-align: center;
      box-sizing: border-box;
    }

    .choice-btn:active {
      transform: scale(0.95);
    }

    #goalBtn {
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #saveBtn {
      background: linear-gradient(135deg, #1565c0, #2196f3);
    }

        #missBtn {
      background: linear-gradient(135deg, #b0bec5, #90a4ae);
      color: #333;
    }
    #cornerBtn {
      background: linear-gradient(135deg, #ff8f00, #ffb300);
    }
    #reboundBtn {
      background: linear-gradient(135deg, #c62828, #ef5350);
    }
    #controlBtn {
      background: linear-gradient(135deg, #6a1b9a, #8e24aa);
    }
    
    .shot-info-miss {
      color: #b0bec5;
      font-weight: bold;
    }
    .shot-info-danger {
      color: #ef5350;
      font-weight: bold;
    }
    .shot-info-control {
      color: #ba68c8;
      font-weight: bold;
    }

    #fieldInstruction {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 15px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    #currentTabTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #tempInfo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 20px 30px;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 500;
      z-index: 250;
      display: none;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.8);
      min-width: 250px;
      max-width: 90%;
    }

    #shotInfo {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      font-size: 15px;
      font-weight: 500;
      z-index: 9999;
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.4);
      text-align: center;
      max-width: 85%;
      display: none;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
      min-width: 280px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .shot-info-header {
      font-size: 18px;
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 15px;
      text-align: center;
    }

    .shot-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .shot-info-label {
      color: #aaa;
    }

    .shot-info-value {
      color: white;
      font-weight: bold;
    }

    .shot-info-goal {
      color: #4caf50;
      font-weight: bold;
    }

    .shot-info-save {
      color: #2196f3;
      font-weight: bold;
    }

    .shot-info-footer {
      margin-top: 15px;
      font-size: 12px;
      color: #888;
      text-align: center;
    }

    .active-tab {
      display: block !important;
    }

    #debugToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4fc3f7;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    #debugPanel {
      position: fixed;
      top: 60px;
      right: 10px;
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 9998;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      border: 2px solid #4fc3f7;
      font-size: 12px;
      font-family: monospace;
    }

    .debug-log {
      margin: 5px 0;
      padding: 3px;
      border-left: 3px solid #4fc3f7;
      background: rgba(79, 195, 247, 0.1);
    }

    .debug-error {
      border-left-color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      color: #ff8888;
    }

    .debug-success {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
      color: #a5d6a7;
    }

        .situation-select {
      width: 100%;
      padding: 12px 15px;
      margin: 10px 0 15px 0;
      background: rgba(20, 20, 20, 0.9);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      backdrop-filter: blur(5px);
    }
    
    .situation-select option {
      background: #222;
      color: white;
    }
    
    .select-label {
      text-align: left;
      color: #aaa;
      font-size: 13px;
      margin-top: 5px;
    }
    
  </style>
</head>
<body>
  <div id="rotateScreen">
    <svg viewBox="0 0 24 24" fill="white" width="60" height="60">
      <path d="M19 12h-1.5c-.82 0-1.5-.68-1.5-1.5V5.5C16 4.67 16.67 4 17.5 4H19c.83 0 1.5.67 1.5 1.5v3.5c0 .83-.67 1.5-1.5 1.5H1L1.01 21c0 1.1.89 2 2 2H21c1.1 0 2-.9 2-2L22.99 14H19zm-5.5-9H8.5V8h4V4zm6 14H2v2h18v-2z"/>
    </svg>
    <p style="margin-top: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
  </div>

  <div id="mainInterface">
    <div id="tabsPanel">
      <div class="tab active" data-tab="video">
        <div class="tab-icon">üé•</div>
      </div>
      <div class="tab" data-tab="field">
        <div class="tab-icon">üèí</div>
      </div>
    </div>

    <div id="currentTabTitle">üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞</div>

    <div id="tempInfo"></div>
    <div id="shotInfo"></div>

    <div id="recordingIndicator">
      <div class="recordingDot"></div>
      <span>–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å</span>
    </div>

    <div id="recordingTimer">00:00:00</div>

    <div id="videoContainer" class="active-tab">
  <div id="youtube-player" style="width:100%; height:100%;"></div>
  <div id="controls">
    <button id="startBtn" class="control-btn" disabled>–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button id="stopBtn" class="control-btn">–°—Ç–æ–ø</button>
  </div>
</div>

     <div id="fieldContainer">
      <div id="imageWrapper">
        <img id="fieldImage" src="ice.png" alt="–•–æ–∫–∫–µ–π–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞">
      </div>
      <div id="fieldInstruction">–û—Ç–º–µ—Ç—å—Ç–µ —Ç–æ—á–∫—É –±—Ä–æ—Å–∫–∞ –Ω–∞ –ø–æ–ª–µ</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ (–ì–æ–ª/–°—ç–π–≤/–ú–∏–º–æ) -->
    <div id="choiceModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
        <div class="choice-buttons">
          <button id="goalBtn" class="choice-btn">–ì–æ–ª</button>
          <button id="saveBtn" class="choice-btn">–°—ç–π–≤</button>
          <button id="missBtn" class="choice-btn">–ú–∏–º–æ</button>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–∏–ø–∞ —Å—ç–π–≤–∞ -->
      <div id="saveTypeModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">–¢–∏–ø —Å—ç–π–≤–∞</div>
        <div class="choice-buttons">
          <button id="cornerBtn" class="choice-btn">–í —É–≥–æ–ª</button>
          <button id="reboundBtn" class="choice-btn">–ù–∞ –ø—è—Ç–∞–∫</button>
          <button id="controlBtn" class="choice-btn">–§–∏–∫—Å–∞—Ü–∏—è</button>
        </div>
      </div>
    </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–≥—Ä–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ -->
    <div id="situationModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">–ò–≥—Ä–æ–≤–∞—è —Å–∏—Ç—É–∞—Ü–∏—è</div>
        
        <!-- –û–±—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –Ω–∞ –ø–æ–ª–µ -->
        <div class="select-label">–°–æ—Å—Ç–∞–≤—ã –Ω–∞ –ª—å–¥—É</div>
        <select id="generalSituation" class="situation-select">
          <option value="5x5">5√ó5 (—Ä–∞–≤–Ω—ã–µ)</option>
          <option value="5x4">5√ó4 (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ)</option>
          <option value="5x3">5√ó3 (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ 2)</option>
          <option value="4x5">4√ó5 (–º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–æ)</option>
          <option value="3x5">3√ó5 (–º–µ–Ω—å—à–∏–Ω—Å—Ç–≤–æ 2)</option>
          <option value="3x3">3√ó3 (–æ–≤–µ—Ä—Ç–∞–π–º)</option>
          <option value="empty_net">–ü—É—Å—Ç—ã–µ –≤–æ—Ä–æ—Ç–∞</option>
        </select>
        
        <!-- –°–∏—Ç—É–∞—Ü–∏—è —É –≤–æ—Ä–æ—Ç -->
        <div class="select-label">–°–∏—Ç—É–∞—Ü–∏—è —É –≤–æ—Ä–æ—Ç</div>
        <select id="goalAreaSituation" class="situation-select">
          <option value="1x0">1√ó0 (–≤—ã—Ö–æ–¥ 1 –Ω–∞ 1)</option>
          <option value="2x0">2√ó0</option>
          <option value="2x1">2√ó1</option>
          <option value="3x2">3√ó2</option>
          <option value="normal">–ü–æ–∑–∏—Ü–∏–æ–Ω–Ω–∞—è –∞—Ç–∞–∫–∞</option>
        </select>
        
        <div class="choice-buttons" style="margin-top: 20px;">
          <button id="situationConfirmBtn" class="choice-btn" style="background: linear-gradient(135deg, #2e7d32, #4caf50);">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
      </div>
    </div>
    
  <button id="debugToggle">üêõ</button>
  <div id="debugPanel"></div>

  <script>
    (function() {
      // === –ë–õ–û–ö –ö–û–ù–°–¢–ê–ù–¢ ===
const ORIGINAL_IMAGE_WIDTH = 417;
const ORIGINAL_IMAGE_HEIGHT = 436;

// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
const ORIGINAL_GOAL_COORDS = { x: 208.5, y: 377 };     // —Ü–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç
const ORIGINAL_CENTER_COORDS = { x: 208.5, y: 8 };     // —Ü–µ–Ω—Ç—Ä –ø–ª–æ—â–∞–¥–∫–∏

// –†–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –º–µ—Ç—Ä–∞—Ö
const DISTANCE_CENTER_TO_GOAL = 26.5;  // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ø–ª–æ—â–∞–¥–∫–∏ –¥–æ –≤–æ—Ä–æ—Ç
const RINK_WIDTH_METERS = 26;          // —à–∏—Ä–∏–Ω–∞ –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∫–∏
const GOAL_WIDTH_METERS = 1.83;        // —à–∏—Ä–∏–Ω–∞ –≤–æ—Ä–æ—Ç

// –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä—ã –Ω–∞ –ø–∏–∫—Å–µ–ª—å –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ (Y)
// –û—Ç —Ü–µ–Ω—Ç—Ä–∞ –ø–ª–æ—â–∞–¥–∫–∏ (y=8) –¥–æ –≤–æ—Ä–æ—Ç (y=377) = 369 –ø–∏–∫—Å–µ–ª–µ–π = 26.5 –º–µ—Ç—Ä–æ–≤
const PIXELS_CENTER_TO_GOAL = ORIGINAL_GOAL_COORDS.y - ORIGINAL_CENTER_COORDS.y; // 369
const METERS_PER_PIXEL_Y = DISTANCE_CENTER_TO_GOAL / PIXELS_CENTER_TO_GOAL;      // 26.5 / 369 = 0.0718 –º/–ø–∏–∫—Å

// –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä—ã –Ω–∞ –ø–∏–∫—Å–µ–ª—å –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (X)
// –í—Å—è —à–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è 417 –ø–∏–∫—Å–µ–ª–µ–π = 26 –º–µ—Ç—Ä–æ–≤
const METERS_PER_PIXEL_X = RINK_WIDTH_METERS / ORIGINAL_IMAGE_WIDTH;             // 26 / 417 = 0.06235 –º/–ø–∏–∫—Å

// –î–ª—è —Å–ø—Ä–∞–≤–∫–∏: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —à—Ç–∞–Ω–≥ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
const LEFT_POST_X = ORIGINAL_GOAL_COORDS.x - (GOAL_WIDTH_METERS / 2) / METERS_PER_PIXEL_X;  // 208.5 - 14.68 = 193.82
const RIGHT_POST_X = ORIGINAL_GOAL_COORDS.x + (GOAL_WIDTH_METERS / 2) / METERS_PER_PIXEL_X; // 208.5 + 14.68 = 223.18

      // === –¢–ê–ô–ú–ï–†–´ –î–õ–Ø –ò–°–ß–ï–ó–ê–Æ–©–ò–• –¢–ê–ë–õ–ò–ß–ï–ö ===
      let videoTitleTimer = null;
      let fieldTitleTimer = null;
      let fieldInstructionTimer = null;

      // === TELEGRAM ===
let telegramAvailable = false;
if (window.Telegram?.WebApp) {
  telegramAvailable = true;
  Telegram.WebApp.ready();
  Telegram.WebApp.disableClosingConfirmation();
  Telegram.WebApp.expand();
  setTimeout(() => Telegram.WebApp.expand(), 300);
  setTimeout(() => Telegram.WebApp.expand(), 1000);
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è YouTube API (–æ–±—ä—è–≤–ª—è–µ–º –≤–Ω–µ IIFE)
window.player = null;
window.videoUrl = null;

// –ó–∞–≥—Ä—É–∂–∞–µ–º YouTube IFrame API
let tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
let firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è API
window.onYouTubeIframeAPIReady = function() {
  console.log('üé¨ YouTube API –≥–æ—Ç–æ–≤');
  if (window.videoUrl) {
    initYouTubePlayer(window.videoUrl);
  }
};

function initYouTubePlayer(url) {
  let videoId = extractVideoId(url);
  if (!videoId) {
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å ID –≤–∏–¥–µ–æ');
    return;
  }
  
  console.log('üé¨ –ó–∞–≥—Ä—É–∂–∞—é –≤–∏–¥–µ–æ ID:', videoId);
  
  window.player = new YT.Player('youtube-player', {
    height: '100%',
    width: '100%',
    videoId: videoId,
    playerVars: {
      'autoplay': 0,
      'controls': 1,
      'rel': 0,
      'modestbranding': 1,
      'playsinline': 1,
      'enablejsapi': 1
    },
    events: {
      'onReady': onPlayerReady,
      'onStateChange': onPlayerStateChange,
      'onError': onPlayerError
    }
  });
}

function extractVideoId(url) {
  if (!url) return null;
  
  // –î–ª—è youtube.com/live/...
  if (url.includes('youtube.com/live/')) {
    return url.split('youtube.com/live/')[1].split('?')[0].split('/')[0];
  }
  // –î–ª—è youtu.be/...
  else if (url.includes('youtu.be/')) {
    return url.split('youtu.be/')[1].split('?')[0];
  }
  // –î–ª—è youtube.com/watch?v=...
  else if (url.includes('v=')) {
    return url.split('v=')[1].split('&')[0];
  }
  // –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ ID
  else if (url.length === 11) {
    return url;
  }
  
  console.error('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç URL:', url);
  return null;
}

function onPlayerReady(event) {
  console.log('‚úÖ –ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤');
  startBtn.disabled = false;
  addDebugLog('‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
}

function onPlayerStateChange(event) {
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
  if (window.player && window.player.getCurrentTime) {
    videoCurrentTime = window.player.getCurrentTime();
    window.videoCurrentTime = videoCurrentTime;
  }
}

function onPlayerError(event) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –ø–ª–µ–µ—Ä–∞:', event.data);
  addDebugLog(`‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: ${event.data}`, 'error');
}
      
      // === DOM –≠–õ–ï–ú–ï–ù–¢–´ ===
      const rotateScreen = document.getElementById('rotateScreen');
      const mainInterface = document.getElementById('mainInterface');
      const tabsPanel = document.getElementById('tabsPanel');
      const videoContainer = document.getElementById('videoContainer');
      const fieldContainer = document.getElementById('fieldContainer');
      const videoFrame = document.getElementById('videoFrame');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const fieldImage = document.getElementById('fieldImage');
      const imageWrapper = document.getElementById('imageWrapper');
      const fieldInstruction = document.getElementById('fieldInstruction');
      const recordingIndicator = document.getElementById('recordingIndicator');
      const recordingTimer = document.getElementById('recordingTimer');
      const choiceModal = document.getElementById('choiceModal');
      const goalBtn = document.getElementById('goalBtn');
      const saveBtn = document.getElementById('saveBtn');
      const missBtn = document.getElementById('missBtn');
      const saveTypeModal = document.getElementById('saveTypeModal');
      const cornerBtn = document.getElementById('cornerBtn');
      const reboundBtn = document.getElementById('reboundBtn');
      const controlBtn = document.getElementById('controlBtn');
            const situationModal = document.getElementById('situationModal');
      const generalSituation = document.getElementById('generalSituation');
      const goalAreaSituation = document.getElementById('goalAreaSituation');
      const situationConfirmBtn = document.getElementById('situationConfirmBtn');
      
      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      let pendingEventType = null;
      let pendingSaveType = null;
      const currentTabTitle = document.getElementById('currentTabTitle');
      const shotInfo = document.getElementById('shotInfo');
      const tabs = document.querySelectorAll('.tab');
      const debugToggle = document.getElementById('debugToggle');
      const debugPanel = document.getElementById('debugPanel');

      // === –°–û–°–¢–û–Ø–ù–ò–ï ===
      let isRecording = false;
      let recordingStartTime = null;
      let timerInterval = null;
      let currentTab = 'video';
      let currentMarker = null;
      let isDragging = false;
      let dragStartX = 0, dragStartY = 0;
      let markerStartX = 0, markerStartY = 0;
      let videoCurrentTime = 0;
      let isVideoPaused = false;
      let isImageLoaded = false;
      let lastShotData = null;
      let scaleFactor = 1;
      let imageOffset = { left: 0, top: 0 };
      window.recordingStartTime = null;
      window.videoCurrentTime = 0;
      
                  // URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
      const urlParams = new URLSearchParams(window.location.search);
      
      // –í–∏–¥–µ–æ URL
      const videoUrl = urlParams.get('video');  // ‚Üê –ó–ê–ü–Ø–¢–ê–Ø –ó–î–ï–°–¨!
      window.videoUrl = videoUrl;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è YouTube API
      
      // üî• –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ match_id —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
      const rawMatchId = urlParams.get('match_id');
      let matchId = '1'; // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
      console.log('üîç Raw match_id –∏–∑ URL:', rawMatchId);
      
      if (rawMatchId && rawMatchId !== 'undefined' && rawMatchId !== 'null') {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
        const cleaned = rawMatchId.toString().trim().replace(/\s+/g, '');
        const parsed = parseInt(cleaned, 10);
        
        if (!isNaN(parsed) && parsed > 0) {
          matchId = parsed.toString();
          console.log('‚úÖ match_id –≤–∞–ª–∏–¥–Ω—ã–π:', matchId);
        } else {
          console.error('‚ùå match_id –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω:', rawMatchId, '‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º 1');
        }
      } else {
        console.log('‚ÑπÔ∏è match_id –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º 1');
      }
      
      // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      console.log('üìå –ò—Ç–æ–≥–æ–≤—ã–π matchId:', matchId, '—Ç–∏–ø:', typeof matchId);

      // === –î–ï–ë–ê–ì ===
      let debugLogs = [];
      function addDebugLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const log = `[${timestamp}] ${message}`;
        debugLogs.push({ message: log, type });
        if (debugLogs.length > 20) debugLogs = debugLogs.slice(-20);
        
        let html = '<strong>Debug Logs:</strong><br><br>';
        debugLogs.forEach(log => {
          const cls = log.type === 'error' ? 'debug-error' : 
                     log.type === 'success' ? 'debug-success' : 'debug-log';
          html += `<div class="${cls}">${log.message}</div>`;
        });
        debugPanel.innerHTML = html;
        debugPanel.scrollTop = debugPanel.scrollHeight;
        console.log(`[${type}] ${message}`);
      }
      
      debugToggle.addEventListener('click', () => {
        debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
      });

      // === –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–†–ï–ú–ï–ù–ù–û–ì–û –ü–û–ö–ê–ó–ê –≠–õ–ï–ú–ï–ù–¢–û–í ===
      function showTemporary(element, duration = 3000) {
        if (!element) return;
        
        element.style.display = 'block';
        
        if (element.id === 'currentTabTitle') {
          if (videoTitleTimer) clearTimeout(videoTitleTimer);
          videoTitleTimer = setTimeout(() => {
            element.style.display = 'none';
            videoTitleTimer = null;
          }, duration);
        }
        else if (element.id === 'fieldInstruction') {
          if (fieldInstructionTimer) clearTimeout(fieldInstructionTimer);
          fieldInstructionTimer = setTimeout(() => {
            element.style.display = 'none';
            fieldInstructionTimer = null;
          }, duration);
        }
      }

      // === –û–†–ò–ï–ù–¢–ê–¶–ò–Ø ===
      function checkOrientation() {
        const isLandscape = window.innerWidth > window.innerHeight;
        rotateScreen.style.display = isLandscape ? 'none' : 'flex';
        mainInterface.style.display = isLandscape ? 'block' : 'none';
        if (isLandscape && isImageLoaded) updateImageMetrics();
      }
      window.addEventListener('resize', checkOrientation);
      checkOrientation();

      // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ú–ï–¢–†–ò–ö –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ===
      function updateImageMetrics() {
        if (!isImageLoaded) return;
        const imageRect = fieldImage.getBoundingClientRect();
        const containerRect = fieldContainer.getBoundingClientRect();
        scaleFactor = imageRect.width / ORIGINAL_IMAGE_WIDTH;
        imageOffset = {
          left: imageRect.left - containerRect.left,
          top: imageRect.top - containerRect.top
        };
        addDebugLog(`Scale: ${scaleFactor.toFixed(3)}, Offset: ${imageOffset.left.toFixed(1)},${imageOffset.top.toFixed(1)}`);
      }

      // === –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò ===
      function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      function updateTimer() {
        if (recordingStartTime) {
          recordingTimer.textContent = formatTime(Date.now() - recordingStartTime);
        }
      }

      // === –í–ò–î–ï–û ===
      function pauseYouTubeVideo() {
  if (player && player.pauseVideo) {
    player.pauseVideo();
  }
}
      // === –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö ===
      function switchTab(tabName) {
        currentTab = tabName;
        tabs.forEach(tab => {
          tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
        });
        
        if (tabName === 'video') {
          videoContainer.classList.add('active-tab');
          fieldContainer.classList.remove('active-tab');
          currentTabTitle.textContent = 'üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—á–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
          showTemporary(currentTabTitle, 3000);
          
          if (isVideoPaused) pauseYouTubeVideo();
          
          // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∏–¥–µ–æ, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ–≤—ã–µ —Ç–∞–±–ª–∏—á–∫–∏
          if (fieldInstructionTimer) {
            clearTimeout(fieldInstructionTimer);
            fieldInstructionTimer = null;
          }
          fieldInstruction.style.display = 'none';
        } else {
          videoContainer.classList.remove('active-tab');
          fieldContainer.classList.add('active-tab');
          currentTabTitle.textContent = 'üèí –°—Ö–µ–º–∞ –ø–æ–ª—è';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–µ —Ç–∞–±–ª–∏—á–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
          showTemporary(currentTabTitle, 3000);
          showTemporary(fieldInstruction, 3000);
          
          pauseYouTubeVideo();
          isVideoPaused = true;
          if (isImageLoaded) updateImageMetrics();
        }
      }

      // === –§–£–ù–ö–¶–ò–Ø –†–ê–°–ß–ï–¢–ê –†–ê–°–°–¢–û–Ø–ù–ò–Ø –ò –£–ì–õ–ê ===
function calculateDistanceAndAngleFromOriginal(originalX, originalY) {
  // –†–∞–∑–Ω–∏—Ü–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –≤–æ—Ä–æ—Ç
  const dxOriginal = originalX - ORIGINAL_GOAL_COORDS.x;  // –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ = –ø—Ä–∞–≤–µ–µ –≤–æ—Ä–æ—Ç
  const dyOriginal = ORIGINAL_GOAL_COORDS.y - originalY;  // –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ = –¥–∞–ª—å—à–µ –æ—Ç –≤–æ—Ä–æ—Ç
  
  // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –º–µ—Ç—Ä—ã
  const dxMeters = dxOriginal * METERS_PER_PIXEL_X;
  const dyMeters = dyOriginal * METERS_PER_PIXEL_Y;
  
  // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ —Ç–µ–æ—Ä–µ–º–µ –ü–∏—Ñ–∞–≥–æ—Ä–∞
  const distanceMeters = Math.sqrt(dxMeters * dxMeters + dyMeters * dyMeters);
  
  // –£–≥–æ–ª: 0¬∞ = –ø—Ä—è–º–æ –Ω–∞ —Ü–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–ø—Ä–∞–≤–æ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = –Ω–∞–ª–µ–≤–æ
  let angleDeg = Math.atan2(dxMeters, dyMeters) * (180 / Math.PI);
  
  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –¥–ª—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ 1 –∑–Ω–∞–∫–∞ –¥–ª—è —É–≥–ª–∞
  return {
    distance: Math.round(distanceMeters * 100) / 100,
    angle: Math.round(angleDeg * 10) / 10
  };
}

      function getClickCoordinates(e, isTouch = false) {
  let clientX, clientY;
  if (isTouch) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX;
    clientY = e.clientY;
  }
  
  const imageRect = fieldImage.getBoundingClientRect();
  
  // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  if (clientX < imageRect.left || clientX > imageRect.right ||
      clientY < imageRect.top || clientY > imageRect.bottom) {
    return null;
  }
  
  const containerRect = fieldContainer.getBoundingClientRect();
  
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–ª—è –º–∞—Ä–∫–µ—Ä–∞)
  const containerX = clientX - containerRect.left;
  const containerY = clientY - containerRect.top;
  
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const imageX = clientX - imageRect.left;
  const imageY = clientY - imageRect.top;
  
  // –ü–µ—Ä–µ—Å—á–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  const scaleX = imageRect.width / ORIGINAL_IMAGE_WIDTH;
  const scaleY = imageRect.height / ORIGINAL_IMAGE_HEIGHT;
  
  const originalX = imageX / scaleX;
  const originalY = imageY / scaleY;
  
  return {
    container: { x: containerX, y: containerY },
    image: { x: imageX, y: imageY },
    original: { x: originalX, y: originalY }
  };
}

      function createMarker(coords) {
  if (!coords) {
    addDebugLog('‚ùå –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞ (–∫–ª–∏–∫ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)', 'error');
    return;
  }
  
  if (currentMarker) currentMarker.remove();
  
  // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
  currentMarker = document.createElement('div');
  currentMarker.className = 'marker-point';
  currentMarker.style.left = coords.container.x + 'px';
  currentMarker.style.top = coords.container.y + 'px';
  
  currentMarker.addEventListener('mousedown', startDrag);
  currentMarker.addEventListener('touchstart', startDragTouch, { passive: false });
  
  fieldContainer.appendChild(currentMarker);
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  const result = calculateDistanceAndAngleFromOriginal(coords.original.x, coords.original.y);
  
  lastShotData = {
    originalX: coords.original.x,
    originalY: coords.original.y,
    distance: result.distance,
    angle: result.angle
  };
  
  addDebugLog(`‚úÖ –ë—Ä–æ—Å–æ–∫: –æ—Ä–∏–≥(${coords.original.x.toFixed(1)},${coords.original.y.toFixed(1)}) ‚Üí ${result.distance}–º, ${result.angle}¬∞`);
  
  setTimeout(() => choiceModal.classList.add('visible'), 300);
}
      function handleFieldClick(e) {
  if (e.target.classList.contains('marker-point')) return;
  
  // –ü–û–õ–£–ß–ê–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´ –ö–õ–ò–ö–ê
  const rect = fieldImage.getBoundingClientRect();
  
  // –ü–†–û–í–ï–†–ö–ê: –∫–ª–∏–∫ —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  if (e.clientX >= rect.left && 
      e.clientX <= rect.right && 
      e.clientY >= rect.top && 
      e.clientY <= rect.bottom) {
    
    const coords = getClickCoordinates(e, false);
    createMarker(coords);
  } else {
    addDebugLog('‚ùå –ö–ª–∏–∫ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
  }
}

function handleFieldTouch(e) {
  if (e.touches.length !== 1) return;
  e.preventDefault();
  
  const touch = e.touches[0];
  const element = document.elementFromPoint(touch.clientX, touch.clientY);
  if (element?.classList.contains('marker-point')) return;
  
  // –¢–ê –ñ–ï –ü–†–û–í–ï–†–ö–ê –î–õ–Ø –¢–ê–ß–ê
  const rect = fieldImage.getBoundingClientRect();
  
  if (touch.clientX >= rect.left && 
      touch.clientX <= rect.right && 
      touch.clientY >= rect.top && 
      touch.clientY <= rect.bottom) {
    
    const coords = getClickCoordinates(e, true);
    createMarker(coords);
  } else {
    addDebugLog('‚ùå –¢–∞—á –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
  }
}

            function handleImageClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const rect = fieldImage.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        createMarkerFromImageCoords(x, y);
      }

      function handleImageTouch(e) {
        if (e.touches.length !== 1) return;
        e.preventDefault();
        e.stopPropagation();
        
        const touch = e.touches[0];
        const rect = fieldImage.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        createMarkerFromImageCoords(x, y);
      }

      function createMarkerFromImageCoords(imageX, imageY) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (imageX < 0 || imageX > fieldImage.clientWidth || 
            imageY < 0 || imageY > fieldImage.clientHeight) {
          addDebugLog('‚ùå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
          return;
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
        if (currentMarker) currentMarker.remove();
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
        const imageRect = fieldImage.getBoundingClientRect();
        const containerRect = fieldContainer.getBoundingClientRect();
        
        const containerX = imageRect.left - containerRect.left + imageX;
        const containerY = imageRect.top - containerRect.top + imageY;
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
        currentMarker = document.createElement('div');
        currentMarker.className = 'marker-point';
        currentMarker.style.left = containerX + 'px';
        currentMarker.style.top = containerY + 'px';
        
        currentMarker.addEventListener('mousedown', startDrag);
        currentMarker.addEventListener('touchstart', startDragTouch, { passive: false });
        
        fieldContainer.appendChild(currentMarker);
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const scaleX = imageRect.width / ORIGINAL_IMAGE_WIDTH;
        const scaleY = imageRect.height / ORIGINAL_IMAGE_HEIGHT;
        
        const originalX = imageX / scaleX;
        const originalY = imageY / scaleY;
        
        const result = calculateDistanceAndAngleFromOriginal(originalX, originalY);
        
        lastShotData = {
          originalX, originalY,
          distance: result.distance,
          angle: result.angle
        };
        
        addDebugLog(`‚úÖ –ë—Ä–æ—Å–æ–∫: –æ—Ä–∏–≥(${originalX.toFixed(1)},${originalY.toFixed(1)}) ‚Üí ${result.distance}–º, ${result.angle}¬∞`);
        
        setTimeout(() => choiceModal.classList.add('visible'), 300);
      }
      
      // === DRAG LOGIC ===
      function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        isDragging = true;
        currentMarker.classList.add('dragging');
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        markerStartX = currentMarker.offsetLeft;
        markerStartY = currentMarker.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
      }

      function startDragTouch(e) {
        if (e.touches.length !== 1) return;
        e.preventDefault();
        e.stopPropagation();
        isDragging = true;
        currentMarker.classList.add('dragging');
        const touch = e.touches[0];
        dragStartX = touch.clientX;
        dragStartY = touch.clientY;
        markerStartX = currentMarker.offsetLeft;
        markerStartY = currentMarker.offsetTop;
        document.addEventListener('touchmove', dragTouch, { passive: false });
        document.addEventListener('touchend', stopDragTouch);
      }

            function drag(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;
        let newX = markerStartX + deltaX;
        let newY = markerStartY + deltaY;
        
        // –ì—Ä–∞–Ω–∏—Ü—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const imageRect = fieldImage.getBoundingClientRect();
        const containerRect = fieldContainer.getBoundingClientRect();
        
        const minX = imageRect.left - containerRect.left;
        const maxX = imageRect.right - containerRect.left;
        const minY = imageRect.top - containerRect.top;
        const maxY = imageRect.bottom - containerRect.top;
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º
        newX = Math.max(minX, Math.min(maxX, newX));
        newY = Math.max(minY, Math.min(maxY, newY));
        
        currentMarker.style.left = newX + 'px';
        currentMarker.style.top = newY + 'px';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
        const markerWindowX = containerRect.left + newX;
        const markerWindowY = containerRect.top + newY;
        
        const imageX = markerWindowX - imageRect.left;
        const imageY = markerWindowY - imageRect.top;
        
        const scaleX = imageRect.width / ORIGINAL_IMAGE_WIDTH;
        const scaleY = imageRect.height / ORIGINAL_IMAGE_HEIGHT;
        const originalX = imageX / scaleX;
        const originalY = imageY / scaleY;
        
        const result = calculateDistanceAndAngleFromOriginal(originalX, originalY);
        
        lastShotData = {
          originalX, originalY,
          distance: result.distance,
          angle: result.angle
        };
      }

function dragTouch(e) {
  if (!isDragging || e.touches.length !== 1) return;
  e.preventDefault();
  
  const touch = e.touches[0];
  const deltaX = touch.clientX - dragStartX;
  const deltaY = touch.clientY - dragStartY;
  let newX = markerStartX + deltaX;
  let newY = markerStartY + deltaY;
  
  // –ì—Ä–∞–Ω–∏—Ü—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  const imageRect = fieldImage.getBoundingClientRect();
  const containerRect = fieldContainer.getBoundingClientRect();
  
  const minX = imageRect.left - containerRect.left;
  const maxX = imageRect.right - containerRect.left;
  const minY = imageRect.top - containerRect.top;
  const maxY = imageRect.bottom - containerRect.top;
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º
  newX = Math.max(minX, Math.min(maxX, newX));
  newY = Math.max(minY, Math.min(maxY, newY));
  
  currentMarker.style.left = newX + 'px';
  currentMarker.style.top = newY + 'px';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
  const markerWindowX = containerRect.left + newX;
  const markerWindowY = containerRect.top + newY;
  
  const imageX = markerWindowX - imageRect.left;
  const imageY = markerWindowY - imageRect.top;
  
  const scaleX = imageRect.width / ORIGINAL_IMAGE_WIDTH;
  const scaleY = imageRect.height / ORIGINAL_IMAGE_HEIGHT;
  const originalX = imageX / scaleX;
  const originalY = imageY / scaleY;
  
  const result = calculateDistanceAndAngleFromOriginal(originalX, originalY);
  
  lastShotData = {
    originalX, originalY,
    distance: result.distance,
    angle: result.angle
  };
}

      function stopDrag() {
        isDragging = false;
        currentMarker?.classList.remove('dragging');
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
      }

      function stopDragTouch() {
        isDragging = false;
        currentMarker?.classList.remove('dragging');
        document.removeEventListener('touchmove', dragTouch);
        document.removeEventListener('touchend', stopDragTouch);
      }

      // === –ó–ê–ü–ò–°–¨ –ú–û–ú–ï–ù–¢–û–í (–ë–ï–ó –í–ò–î–ï–û) ===
function startRecording() {
  if (isRecording) return;
  
  isRecording = true;
  recordingStartTime = Date.now();
  window.recordingStartTime = recordingStartTime;
  
  // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏
  startBtn.style.display = 'none';
  stopBtn.style.display = 'block';
  
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);
  
  console.log('‚è∫ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞');
  addDebugLog('‚è∫ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞', 'success');
}

function stopRecording() {
  if (!isRecording) return;
  
  isRecording = false;
  if (timerInterval) clearInterval(timerInterval);
  
  // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
  startBtn.style.display = 'block';
  stopBtn.style.display = 'none';
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
  recordingTimer.textContent = '00:00:00';
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å—Ö–µ–º—É –ø–æ–ª—è
  pauseYouTubeVideo();
  isVideoPaused = true;
  tabsPanel.classList.add('visible');
  switchTab('field');
  
  showTemporary(currentTabTitle, 3000);
  showTemporary(fieldInstruction, 3000);
  
  console.log('‚èπ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
  addDebugLog('‚èπ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
}

      
    // === –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–†–ù–£–Æ –ë–î ===
async function sendToServer(eventData) {
  const serverUrl = 'https://shutoutlab.boats/api/save_event';
  
  addDebugLog(`üîµ –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–†: ${serverUrl}`);
  
  try {
    const response = await fetch(serverUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(eventData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      addDebugLog(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ! ID: ${result.event_id}`, 'success');
      return true;
    } else {
      addDebugLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${result.error}`, 'error');
      return false;
    }
  } catch (error) {
    addDebugLog(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ${error.message}`, 'error');
    return false;
  }
}
      
      
                  function showShotResult(eventType, distance, angle) {
        let eventName = '';
        let eventColor = '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ —Å–∏—Ç—É–∞—Ü–∏—è (—Ñ–æ—Ä–º–∞—Ç: —Ç–∏–ø|general|goalArea)
        let baseType = eventType;
        let situationText = '';
        
        if (eventType.includes('|')) {
          const parts = eventType.split('|');
          baseType = parts[0];
          situationText = ` (${parts[1]}, ${parts[2]})`;
        }
        
        switch(baseType) {
          case 'goal':
            eventName = '–ì–æ–ª' + situationText;
            eventColor = 'shot-info-goal';
            break;
          case 'miss':
            eventName = '–ú–∏–º–æ' + situationText;
            eventColor = 'shot-info-miss';
            break;
          case 'save_corner':
            eventName = '–°—ç–π–≤ (–≤ —É–≥–æ–ª)' + situationText;
            eventColor = 'shot-info-save';
            break;
          case 'save_rebound':
            eventName = '–°—ç–π–≤ (–Ω–∞ –ø—è—Ç–∞–∫)' + situationText;
            eventColor = 'shot-info-danger';
            break;
          case 'save_control':
            eventName = '–°—ç–π–≤ (—Ñ–∏–∫—Å–∞—Ü–∏—è)' + situationText;
            eventColor = 'shot-info-control';
            break;
          default:
            eventName = eventType;
            eventColor = 'shot-info-save';
        }
        
        shotInfo.innerHTML = `
          <div class="shot-info-header">‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
          <div class="shot-info-row">
            <span class="shot-info-label">–¢–∏–ø:</span>
            <span class="shot-info-value ${eventColor}">${eventName}</span>
          </div>
          <div class="shot-info-row">
            <span class="shot-info-label">–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span>
            <span class="shot-info-value">${distance} –º</span>
          </div>
          <div class="shot-info-row">
            <span class="shot-info-label">–£–≥–æ–ª:</span>
            <span class="shot-info-value">${angle}¬∞</span>
          </div>
          <div class="shot-info-footer">–ò—Å—á–µ–∑–Ω–µ—Ç —á–µ—Ä–µ–∑ 6 —Å–µ–∫</div>
        `;
        shotInfo.style.display = 'block';
        setTimeout(() => { shotInfo.style.display = 'none'; }, 6000);
      }

                        function handleChoice(type) {
        choiceModal.classList.remove('visible');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
        pendingEventType = type;
        pendingSaveType = null;
        
        if (type === 'save') {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ —Å—ç–π–≤–∞
          saveTypeModal.classList.add('visible');
        } else {
          // –î–ª—è –≥–æ–ª–∞ –∏–ª–∏ –º–∏–º–æ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏
          situationModal.classList.add('visible');
        }
      }

                 function handleSaveType(saveType) {
        saveTypeModal.classList.remove('visible');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Å—ç–π–≤–∞
        pendingSaveType = saveType;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏
        situationModal.classList.add('visible');
      }

            function handleSituationConfirm() {
  console.log('üî• handleSituationConfirm');
  
  situationModal.classList.remove('visible');
  
  const general = generalSituation.value;
  const goalArea = goalAreaSituation.value;
  
  let eventType = pendingEventType;
  if (pendingEventType === 'save' && pendingSaveType) {
    eventType = `save_${pendingSaveType}`;
  }
  
  if (lastShotData) {
    const fullEventType = `${eventType}|${general}|${goalArea}`;
    showShotResult(fullEventType, lastShotData.distance, lastShotData.angle);
    
    // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –î–ê–ù–ù–´–ï –ù–ê –°–ï–†–í–ï–†
    const eventData = {
      match_id: parseInt(matchId, 10),
      event_type: eventType,
      timestamp: Date.now() - (window.recordingStartTime || Date.now()),
      video_time: window.videoCurrentTime || 0,
      distance: lastShotData.distance,
      angle: lastShotData.angle,
      goal_type: 'half_rink',
      general_situation: general,
      goal_area_situation: goalArea,
      original_x: Math.round(lastShotData.originalX * 10) / 10,
      original_y: Math.round(lastShotData.originalY * 10) / 10
    };
    
    // –û–¢–ü–†–ê–í–õ–Ø–ï–ú fetch –ù–ê –°–ï–†–í–ï–†
    fetch('https://shutoutlab.boats/api/save_event', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(eventData)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, ID:', data.event_id);
        addDebugLog(`‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (ID: ${data.event_id})`);
        
    
      }
    })
    .catch(err => {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
      addDebugLog('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
    });
  }
  
  // –û–ß–ò–©–ê–ï–ú –í–°–Å
  pendingEventType = null;
  pendingSaveType = null;
  generalSituation.value = '5x5';
  goalAreaSituation.value = 'normal';
  
  if (currentMarker) {
    currentMarker.remove();
    currentMarker = null;
  }
  
  // –í–û–ó–í–†–ê–©–ê–ï–ú–°–Ø –ù–ê –í–ò–î–ï–û
  switchTab('video');
fieldContainer.classList.remove('active-tab');
videoContainer.classList.add('active-tab');

// –£–±–∏—Ä–∞–µ–º –ø–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫
tabsPanel.classList.remove('visible');
  
  // –°–ë–†–ê–°–´–í–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –ó–ê–ü–ò–°–ò
  isRecording = false;
  recordingStartTime = null;
  if (timerInterval) clearInterval(timerInterval);
  recordingIndicator.style.display = 'none';
  recordingTimer.style.display = 'none';
  startBtn.style.display = 'block';
  stopBtn.style.display = 'none';
}
      
     function clearMarkerAndReturn() {
  if (currentMarker) {
    currentMarker.remove();
    currentMarker = null;
  }
  
  // ‚úÖ –í–û–ó–í–†–ê–©–ê–ï–ú–°–Ø –ù–ê –í–ò–î–ï–û!
  switchTab('video');
  
  showTemporary(currentTabTitle, 3000);
}


     

      setTimeout(() => { startBtn.disabled = false; }, 3000);

      // === –ü–û–î–ü–ò–°–ö–ò ===
            situationConfirmBtn.addEventListener('click', handleSituationConfirm);
startBtn.addEventListener('click', startRecording);
stopBtn.addEventListener('click', stopRecording);
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
      });
      
     imageWrapper.addEventListener('click', handleImageClick);
      imageWrapper.addEventListener('touchstart', handleImageTouch, { passive: false });
      
            goalBtn.addEventListener('click', () => handleChoice('goal'));
      saveBtn.addEventListener('click', () => handleChoice('save'));
      missBtn.addEventListener('click', () => handleChoice('miss'));
      
      cornerBtn.addEventListener('click', () => handleSaveType('corner'));
      reboundBtn.addEventListener('click', () => handleSaveType('rebound'));
      controlBtn.addEventListener('click', () => handleSaveType('control'));
      
      window.addEventListener('resize', () => {
        if (isImageLoaded) updateImageMetrics();
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—á–∫—É –≤–∏–¥–µ–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      setTimeout(() => {
        showTemporary(currentTabTitle, 3000);
      }, 500);

      addDebugLog('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
    })();
  </script>
</body>
</html>













