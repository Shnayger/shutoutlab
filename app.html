<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    #rotateScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
      background: #111;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    #mainInterface {
      display: none;
      height: 100vh;
      position: relative;
      background: #000;
    }

    #recordingIndicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(198, 40, 40, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .recordingDot {
      width: 10px;
      height: 10px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    #recordingTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #videoContainer {
      width: 100%;
      height: 100%;
      background: #000;
      position: relative;
    }

    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #000;
    }

    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 40;
    }

    .control-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      min-width: 140px;
      transition: all 0.2s;
    }

    #startBtn { 
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #startBtn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #stopBtn { 
      background: linear-gradient(135deg, #c62828, #f44336);
      display: none;
    }

    .control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    #tabsPanel {
      position: fixed;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 5px;
      border-radius: 0 15px 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease-out;
    }

    #tabsPanel.visible {
      left: 0;
    }

    .tab {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tab.active {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .tab-icon {
      font-size: 20px;
    }

    .content-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .content-container:not(.active) {
      display: none;
    }

    .content-container.active {
      display: block;
    }

    #fieldContainer {
      background: #0d47a1;
    }

    #fieldImage {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .marker-point {
      position: absolute;
      width: 28px;
      height: 28px;
      background: #FF0000;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      transform: translate(-50%, -50%);
      z-index: 100;
      cursor: move;
      transition: transform 0.1s;
      pointer-events: auto;
    }

    .marker-point.dragging {
      transform: translate(-50%, -50%) scale(1.4);
      z-index: 101;
      box-shadow: 0 0 30px rgba(255, 0, 0, 1);
    }

    .goal-marker {
      position: absolute;
      width: 25px;
      height: 25px;
      background: rgba(0, 255, 0, 0.7);
      border-radius: 50%;
      border: 3px solid white;
      transform: translate(-50%, -50%);
      z-index: 90;
      cursor: pointer;
      pointer-events: auto;
    }

    .goal-marker.selected {
      background: rgba(255, 255, 0, 0.9);
      box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
    }

    #choiceModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(5px);
    }

    #choiceModal.visible {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 30, 0.95);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 25px;
      color: white;
    }

    .choice-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .choice-btn {
      padding: 15px 25px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      color: white;
      flex: 1;
      transition: all 0.2s;
      min-width: 100px;
    }

    .choice-btn:active {
      transform: scale(0.95);
    }

    #goalBtn {
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #saveBtn {
      background: linear-gradient(135deg, #1565c0, #2196f3);
    }

    #fieldInstruction {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    #currentTabTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: none;
    }

    #tempInfo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      z-index: 250;
      display: none;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);
      min-width: 200px;
    }

    #goalSelectionPanel {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>
  <div id="rotateScreen">
    <svg viewBox="0 0 24 24" fill="white" width="60" height="60">
      <path d="M19 12h-1.5c-.82 0-1.5-.68-1.5-1.5V5.5C16 4.67 16.67 4 17.5 4H19c.83 0 1.5.67 1.5 1.5v3.5c0 .83-.67 1.5-1.5 1.5H1L1.01 21c0 1.1.89 2 2 2H21c1.1 0 2-.9 2-2L22.99 14H19zm-5.5-9H8.5V8h4V4zm6 14H2v2h18v-2z"/>
    </svg>
    <p style="margin-top: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
  </div>

  <div id="mainInterface">
    <div id="tabsPanel">
      <div class="tab active" data-tab="video">
        <div class="tab-icon">üé•</div>
      </div>
      <div class="tab" data-tab="field">
        <div class="tab-icon">üèí</div>
      </div>
    </div>

    <div id="currentTabTitle">üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞</div>

    <div id="goalSelectionPanel">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ—Ä–æ—Ç–∞ –¥–ª—è –∞—Ç–∞–∫–∏</div>

    <div id="tempInfo"></div>

    <div id="recordingIndicator">
      <div class="recordingDot"></div>
      <span>–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å</span>
    </div>

    <div id="recordingTimer">00:00:00</div>

    <div id="videoContainer" class="content-container active">
      <iframe id="videoFrame" allowfullscreen></iframe>
      
      <div id="controls">
        <button id="startBtn" class="control-btn" disabled>–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="stopBtn" class="control-btn">–°—Ç–æ–ø</button>
      </div>
    </div>

    <div id="fieldContainer" class="content-container">
      <img id="fieldImage" src="1648780124_3-abrakadabra-fun-p-khokkeinoe-pole-sverkhu-10.jpg" alt="–•–æ–∫–∫–µ–π–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞">
      <div id="fieldInstruction">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ—Ä–æ—Ç–∞ –¥–ª—è –∞—Ç–∞–∫–∏</div>
    </div>

    <div id="choiceModal">
      <div class="modal-content">
        <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
        <div class="choice-buttons">
          <button id="goalBtn" class="choice-btn">–ì–æ–ª</button>
          <button id="saveBtn" class="choice-btn">–°—ç–π–≤</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    if (window.Telegram?.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }

    const rotateScreen = document.getElementById('rotateScreen');
    const mainInterface = document.getElementById('mainInterface');
    const tabsPanel = document.getElementById('tabsPanel');
    const videoContainer = document.getElementById('videoContainer');
    const fieldContainer = document.getElementById('fieldContainer');
    const videoFrame = document.getElementById('videoFrame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fieldImage = document.getElementById('fieldImage');
    const fieldInstruction = document.getElementById('fieldInstruction');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const recordingTimer = document.getElementById('recordingTimer');
    const choiceModal = document.getElementById('choiceModal');
    const goalBtn = document.getElementById('goalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const currentTabTitle = document.getElementById('currentTabTitle');
    const tempInfo = document.getElementById('tempInfo');
    const goalSelectionPanel = document.getElementById('goalSelectionPanel');
    const tabs = document.querySelectorAll('.tab');

    let isRecording = false;
    let recordingStartTime = null;
    let timerInterval = null;
    let events = [];
    let currentTab = 'video';
    let currentMarker = null;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let markerStartX = 0;
    let markerStartY = 0;
    let videoCurrentTime = 0;
    let isVideoPaused = false;
    let selectedGoal = null;
    let goalMarkers = [];

    const ORIGINAL_IMAGE_SIZE = { width: 2050, height: 860 };
    const ORIGINAL_GOAL_COORDS = {
      leftGoal: {
        center: { x: 188, y: 429.5 }
      },
      rightGoal: {
        center: { x: 1861, y: 429 }
      }
    };
    
    const REAL_GOAL_WIDTH = 1.83;
    let scaleFactor = 1;
    let currentGoalCoords = {};
    let pixelsPerMeter = 0;
    let imageDisplayRect = { x: 0, y: 0, width: 0, height: 0 };

    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get('video');

    if (videoUrl) {
      let finalUrl = videoUrl;
      if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        let videoId;
        if (videoUrl.includes('youtu.be/')) {
          videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
        } else {
          videoId = videoUrl.split('v=')[1]?.split('&')[0];
        }
        if (videoId) {
          finalUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&controls=1&enablejsapi=1`;
        }
      } else if (videoUrl.includes('vimeo.com')) {
        const vimeoId = videoUrl.split('/').pop();
        finalUrl = `https://player.vimeo.com/video/${vimeoId}?autoplay=0`;
      }
      videoFrame.src = finalUrl;
    }

    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      rotateScreen.style.display = isLandscape ? 'none' : 'flex';
      mainInterface.style.display = isLandscape ? 'block' : 'none';
    }
    window.addEventListener('resize', checkOrientation);
    checkOrientation();

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
      if (recordingStartTime) {
        const elapsed = Date.now() - recordingStartTime;
        recordingTimer.textContent = formatTime(elapsed);
      }
    }

    function pauseYouTubeVideo() {
      try {
        if (videoFrame.contentWindow) {
          videoFrame.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        }
      } catch (e) {}
    }

    function getVideoCurrentTime() {
      return videoCurrentTime;
    }

    function switchTab(tabName) {
      currentTab = tabName;
      tabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      if (tabName === 'video') {
        videoContainer.classList.add('active');
        fieldContainer.classList.remove('active');
        currentTabTitle.textContent = 'üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞';
        currentTabTitle.style.display = 'block';
        if (isVideoPaused) pauseYouTubeVideo();
      } else {
        videoContainer.classList.remove('active');
        fieldContainer.classList.add('active');
        currentTabTitle.textContent = 'üèí –°—Ö–µ–º–∞ –ø–æ–ª—è';
        currentTabTitle.style.display = 'block';
        pauseYouTubeVideo();
        isVideoPaused = true;
      }
    }

    function initializeGoalCoordinates() {
      if (!fieldImage.complete) {
        fieldImage.onload = function() {
          setTimeout(updateGoalCoordinates, 100);
        };
      } else {
        updateGoalCoordinates();
      }
    }

    function updateGoalCoordinates() {
      const rect = fieldImage.getBoundingClientRect();
      const containerRect = fieldContainer.getBoundingClientRect();
      
      imageDisplayRect = {
        x: rect.left - containerRect.left,
        y: rect.top - containerRect.top,
        width: rect.width,
        height: rect.height
      };
      
      scaleFactor = rect.width / ORIGINAL_IMAGE_SIZE.width;
      
      currentGoalCoords = {
        leftGoal: scaleCoordinates(ORIGINAL_GOAL_COORDS.leftGoal),
        rightGoal: scaleCoordinates(ORIGINAL_GOAL_COORDS.rightGoal)
      };
      
      pixelsPerMeter = (scaleFactor * ORIGINAL_IMAGE_SIZE.width) / 61;
      
      createGoalMarkers();
    }

    function scaleCoordinates(coords) {
      return {
        center: {
          x: coords.center.x * scaleFactor + imageDisplayRect.x,
          y: coords.center.y * scaleFactor + imageDisplayRect.y
        }
      };
    }

    function createGoalMarkers() {
      goalMarkers.forEach(marker => marker.remove());
      goalMarkers = [];
      
      const leftGoalMarker = document.createElement('div');
      leftGoalMarker.className = 'goal-marker';
      leftGoalMarker.dataset.goal = 'leftGoal';
      leftGoalMarker.style.left = currentGoalCoords.leftGoal.center.x + 'px';
      leftGoalMarker.style.top = currentGoalCoords.leftGoal.center.y + 'px';
      leftGoalMarker.addEventListener('click', () => selectGoal('leftGoal'));
      fieldContainer.appendChild(leftGoalMarker);
      goalMarkers.push(leftGoalMarker);
      
      const rightGoalMarker = document.createElement('div');
      rightGoalMarker.className = 'goal-marker';
      rightGoalMarker.dataset.goal = 'rightGoal';
      rightGoalMarker.style.left = currentGoalCoords.rightGoal.center.x + 'px';
      rightGoalMarker.style.top = currentGoalCoords.rightGoal.center.y + 'px';
      rightGoalMarker.addEventListener('click', () => selectGoal('rightGoal'));
      fieldContainer.appendChild(rightGoalMarker);
      goalMarkers.push(rightGoalMarker);
    }

    function selectGoal(goalType) {
      if (selectedGoal) {
        goalMarkers.forEach(marker => marker.classList.remove('selected'));
      }
      
      selectedGoal = goalType;
      goalMarkers.forEach(marker => {
        if (marker.dataset.goal === goalType) {
          marker.classList.add('selected');
        }
      });
      
      fieldInstruction.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –∞—Ç–∞–∫–∏';
      goalSelectionPanel.style.display = 'none';
    }

    function calculateDistanceAndAngle(markerX, markerY) {
      if (!selectedGoal || !currentGoalCoords[selectedGoal]) {
        return { distance: 0, angle: 0 };
      }
      
      const goalCenter = currentGoalCoords[selectedGoal].center;
      
      const dx = goalCenter.x - markerX;
      const dy = goalCenter.y - markerY;
      
      const distancePixels = Math.sqrt(dx * dx + dy * dy);
      const distanceMeters = distancePixels / pixelsPerMeter;
      
      let angleRad = Math.atan2(dx, dy);
      let angleDeg = angleRad * (180 / Math.PI);
      
      if (selectedGoal === 'rightGoal') {
        angleDeg = -angleDeg;
      }
      
      return {
        distance: distanceMeters,
        angle: angleDeg
      };
    }

    function showTempInfo(distance, angle, goalType) {
      const goalName = goalType === 'leftGoal' ? '–õ–µ–≤—ã–µ' : '–ü—Ä–∞–≤—ã–µ';
      tempInfo.innerHTML = `
        <div style="margin-bottom: 8px; color: #4fc3f7;">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:</div>
        <div>–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${distance.toFixed(2)} –º</div>
        <div>–£–≥–æ–ª: ${angle.toFixed(1)}¬∞</div>
        <div>–í–æ—Ä–æ—Ç–∞: ${goalName}</div>
      `;
      tempInfo.style.display = 'block';
      
      setTimeout(() => {
        tempInfo.style.display = 'none';
      }, 3000);
    }

    function createMarker(x, y) {
      if (!selectedGoal) {
        fieldInstruction.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ—Ä–æ—Ç–∞!';
        goalSelectionPanel.style.display = 'block';
        return;
      }
      
      if (currentMarker) currentMarker.remove();
      
      currentMarker = document.createElement('div');
      currentMarker.className = 'marker-point';
      currentMarker.style.left = x + 'px';
      currentMarker.style.top = y + 'px';
      
      currentMarker.addEventListener('mousedown', startDrag);
      currentMarker.addEventListener('touchstart', startDragTouch);
      
      fieldContainer.appendChild(currentMarker);
      
      const result = calculateDistanceAndAngle(x, y);
      showTempInfo(result.distance, result.angle, selectedGoal);
      
      setTimeout(() => {
        choiceModal.classList.add('visible');
      }, 300);
    }

    function startDrag(e) {
      e.preventDefault();
      e.stopPropagation();
      isDragging = true;
      currentMarker.classList.add('dragging');
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
    }

    function startDragTouch(e) {
      e.preventDefault();
      e.stopPropagation();
      if (e.touches.length !== 1) return;
      isDragging = true;
      currentMarker.classList.add('dragging');
      const touch = e.touches[0];
      dragStartX = touch.clientX;
      dragStartY = touch.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('touchmove', dragTouch);
      document.addEventListener('touchend', stopDragTouch);
    }

    function drag(e) {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      
      const result = calculateDistanceAndAngle(newX, newY);
      showTempInfo(result.distance, result.angle, selectedGoal);
    }

    function dragTouch(e) {
      if (!isDragging || e.touches.length !== 1) return;
      const touch = e.touches[0];
      const deltaX = touch.clientX - dragStartX;
      const deltaY = touch.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      
      const result = calculateDistanceAndAngle(newX, newY);
      showTempInfo(result.distance, result.angle, selectedGoal);
    }

    function stopDrag() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
    }

    function stopDragTouch() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('touchmove', dragTouch);
      document.removeEventListener('touchend', stopDragTouch);
    }

    function handleFieldClick(e) {
      if (e.target.classList.contains('marker-point') || 
          e.target.classList.contains('goal-marker')) {
        return;
      }
      
      const rect = fieldContainer.getBoundingClientRect();
      let x, y;
      if (e.type === 'click' || e.type === 'mousedown') {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
      } else if (e.type === 'touchstart') {
        const touch = e.touches[0];
        x = touch.clientX - rect.left;
        y = touch.clientY - rect.top;
      }
      createMarker(x, y);
    }

    function startRecording() {
      if (isRecording) return;
      isRecording = true;
      recordingStartTime = Date.now();
      events = [];
      recordingIndicator.style.display = 'flex';
      recordingTimer.style.display = 'block';
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function stopRecording() {
      if (!isRecording) return;
      isRecording = false;
      videoCurrentTime = getVideoCurrentTime();
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      recordingIndicator.style.display = 'none';
      recordingTimer.style.display = 'none';
      pauseYouTubeVideo();
      isVideoPaused = true;
      tabsPanel.classList.add('visible');
      switchTab('field');
      
      selectedGoal = null;
      goalMarkers.forEach(marker => marker.classList.remove('selected'));
      fieldInstruction.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ—Ä–æ—Ç–∞ –¥–ª—è –∞—Ç–∞–∫–∏';
      goalSelectionPanel.style.display = 'block';
    }

    function handleChoice(type) {
      choiceModal.classList.remove('visible');
      
      let distance = 0;
      let angle = 0;
      
      if (currentMarker && selectedGoal) {
        const markerX = currentMarker.offsetLeft;
        const markerY = currentMarker.offsetTop;
        const result = calculateDistanceAndAngle(markerX, markerY);
        distance = result.distance;
        angle = result.angle;
      }
      
      const eventData = {
        type: type,
        timestamp: Date.now() - recordingStartTime,
        videoTime: videoCurrentTime,
        markerPosition: currentMarker ? {
          x: currentMarker.offsetLeft,
          y: currentMarker.offsetTop
        } : null,
        shotParams: {
          distance: distance.toFixed(2),
          angle: angle.toFixed(1),
          goal: selectedGoal
        }
      };
      
      events.push(eventData);
      
      if (window.Telegram?.WebApp) {
        try {
          Telegram.WebApp.sendData(JSON.stringify({
            action: 'save_event',
            event: eventData
          }));
          console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç:', eventData);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
      }
      
      if (currentMarker) {
        currentMarker.remove();
        currentMarker = null;
      }
      
      selectedGoal = null;
      goalMarkers.forEach(marker => marker.classList.remove('selected'));
      
      switchTab('video');
      tabsPanel.classList.remove('visible');
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      isVideoPaused = false;
    }

    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    fieldContainer.addEventListener('click', handleFieldClick);
    fieldContainer.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        const touch = e.touches[0];
        const rect = fieldContainer.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        const element = document.elementFromPoint(touch.clientX, touch.clientY);
        if (element && element.classList.contains('goal-marker')) {
          return;
        }
        
        createMarker(x, y);
      }
    });

    goalBtn.addEventListener('click', () => handleChoice('goal'));
    saveBtn.addEventListener('click', () => handleChoice('save'));

    function checkVideoReady() {
      window.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.event === 'onReady') {
            startBtn.disabled = false;
          }
          if (data.info && data.info.currentTime !== undefined) {
            videoCurrentTime = data.info.currentTime;
          }
        } catch (e) {}
      });
      setTimeout(() => {
        startBtn.disabled = false;
      }, 3000);
    }
    checkVideoReady();

    fieldImage.onload = function() {
      initializeGoalCoordinates();
    };
    fieldImage.onerror = function() {
      fieldInstruction.textContent = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å';
      fieldInstruction.style.backgroundColor = 'rgba(198, 40, 40, 0.9)';
    };

    document.addEventListener('DOMContentLoaded', function() {
      currentTabTitle.style.display = 'block';
    });
  </script>
</body>
</html>
