<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—á–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #000;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    #rotateScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
      padding: 20px;
      background: #111;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    #mainInterface {
      display: none;
      height: 100vh;
      position: relative;
      background: #000;
    }

    #recordingIndicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(198, 40, 40, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .recordingDot {
      width: 10px;
      height: 10px;
      background: #ff4444;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    #recordingTimer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 50;
      display: none;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #videoContainer {
      width: 100%;
      height: 100%;
      background: #000;
      position: relative;
      display: none;
    }

    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #000;
    }

    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 40;
    }

    .control-btn {
      padding: 14px 28px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      color: white;
      min-width: 140px;
      transition: all 0.2s;
    }

    #startBtn { 
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #startBtn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #stopBtn { 
      background: linear-gradient(135deg, #c62828, #f44336);
      display: none;
    }

    .control-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    #tabsPanel {
      position: fixed;
      left: -60px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 5px;
      border-radius: 0 15px 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease-out;
    }

    #tabsPanel.visible {
      left: 0;
    }

    .tab {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tab.active {
      background: rgba(59, 130, 246, 0.8);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .tab-icon {
      font-size: 20px;
    }

    #fieldContainer {
      width: 100%;
      height: 100%;
      background: #000;
      position: relative;
      overflow: hidden;
      display: none;
    }

    #fieldImage {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      pointer-events: none;
    }

    .marker-point {
      position: absolute;
      width: 28px;
      height: 28px;
      background: #FF0000;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.9);
      transform: translate(-50%, -50%);
      z-index: 30;
      cursor: move;
      transition: transform 0.1s;
    }

    .marker-point.dragging {
      transform: translate(-50%, -50%) scale(1.4);
      z-index: 31;
      box-shadow: 0 0 30px rgba(255, 0, 0, 1);
    }

    #choiceModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(5px);
    }

    #choiceModal.visible {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 30, 0.95);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 25px;
      color: white;
    }

    .choice-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .choice-btn {
      padding: 15px 25px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      color: white;
      flex: 1;
      transition: all 0.2s;
      min-width: 100px;
    }

    .choice-btn:active {
      transform: scale(0.95);
    }

    #goalBtn {
      background: linear-gradient(135deg, #2e7d32, #4caf50);
    }

    #saveBtn {
      background: linear-gradient(135deg, #1565c0, #2196f3);
    }

    #fieldInstruction {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 15px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: center;
      max-width: 90%;
      white-space: nowrap;
    }

    #currentTabTitle {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      z-index: 45;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #tempInfo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 20px 30px;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 500;
      z-index: 250;
      display: none;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 5px 30px rgba(0, 0, 0, 0.8);
      min-width: 250px;
      max-width: 90%;
    }

    #shotInfo {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      font-size: 15px;
      font-weight: 500;
      z-index: 9999;
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.4);
      text-align: center;
      max-width: 85%;
      display: none;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
      min-width: 280px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .shot-info-header {
      font-size: 18px;
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 15px;
      text-align: center;
    }

    .shot-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .shot-info-label {
      color: #aaa;
    }

    .shot-info-value {
      color: white;
      font-weight: bold;
    }

    .shot-info-goal {
      color: #4caf50;
      font-weight: bold;
    }

    .shot-info-save {
      color: #2196f3;
      font-weight: bold;
    }

    .shot-info-footer {
      margin-top: 15px;
      font-size: 12px;
      color: #888;
      text-align: center;
    }

    .active-tab {
      display: block !important;
    }

    /* –î–µ–±–∞–≥ —Å—Ç–∏–ª–∏ */
    #debugToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4fc3f7;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    #debugPanel {
      position: fixed;
      top: 60px;
      right: 10px;
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 9998;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      border: 2px solid #4fc3f7;
      font-size: 12px;
      font-family: monospace;
    }

    .debug-log {
      margin: 5px 0;
      padding: 3px;
      border-left: 3px solid #4fc3f7;
      background: rgba(79, 195, 247, 0.1);
    }

    .debug-error {
      border-left-color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      color: #ff8888;
    }

    .debug-success {
      border-left-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
      color: #a5d6a7;
    }
  </style>
</head>
<body>
  <div id="rotateScreen">
    <svg viewBox="0 0 24 24" fill="white" width="60" height="60">
      <path d="M19 12h-1.5c-.82 0-1.5-.68-1.5-1.5V5.5C16 4.67 16.67 4 17.5 4H19c.83 0 1.5.67 1.5 1.5v3.5c0 .83-.67 1.5-1.5 1.5H1L1.01 21c0 1.1.89 2 2 2H21c1.1 0 2-.9 2-2L22.99 14H19zm-5.5-9H8.5V8h4V4zm6 14H2v2h18v-2z"/>
    </svg>
    <p style="margin-top: 20px;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
  </div>

  <div id="mainInterface">
    <div id="tabsPanel">
      <div class="tab active" data-tab="video">
        <div class="tab-icon">üé•</div>
      </div>
      <div class="tab" data-tab="field">
        <div class="tab-icon">üèí</div>
      </div>
    </div>

    <div id="currentTabTitle">üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞</div>

    <div id="tempInfo"></div>
    <div id="shotInfo"></div>

    <div id="recordingIndicator">
      <div class="recordingDot"></div>
      <span>–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å</span>
    </div>

    <div id="recordingTimer">00:00:00</div>

    <div id="videoContainer" class="active-tab">
      <iframe id="videoFrame" allowfullscreen></iframe>
      
      <div id="controls">
        <button id="startBtn" class="control-btn" disabled>–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="stopBtn" class="control-btn">–°—Ç–æ–ø</button>
      </div>
    </div>

    <div id="fieldContainer">
      <img id="fieldImage" src="1676331593_grizly-club-p-khokkeinoe-pole-klipart-16.jpg" alt="–•–æ–∫–∫–µ–π–Ω–∞—è –ø–ª–æ—â–∞–¥–∫–∞">
      <div id="fieldInstruction">–û—Ç–º–µ—Ç—å—Ç–µ —Ç–æ—á–∫—É –±—Ä–æ—Å–∫–∞ –Ω–∞ –ø–æ–ª–µ</div>
    </div>

    <div id="choiceModal">
      <div class="modal-content">
        <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
        <div class="choice-buttons">
          <button id="goalBtn" class="choice-btn">–ì–æ–ª</button>
          <button id="saveBtn" class="choice-btn">–°—ç–π–≤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –î–µ–±–∞–≥ —ç–ª–µ–º–µ–Ω—Ç—ã -->
  <button id="debugToggle">üêõ</button>
  <div id="debugPanel"></div>

  <script>
    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEB APP ===
    console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEB APP ===');
    
    let telegramAvailable = false;
    if (window.Telegram?.WebApp) {
      telegramAvailable = true;
      console.log('‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω');
      console.log('–í–µ—Ä—Å–∏—è:', Telegram.WebApp.version);
      console.log('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', Telegram.WebApp.platform);
      console.log('Init Data:', Telegram.WebApp.initData);
      
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    } else {
      console.log('‚ùå Telegram WebApp –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω! –ó–∞–ø—É—Å–∫–∞–µ—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ?');
      console.log('–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞');
    }

    // === –î–ï–ë–ê–ì –§–£–ù–ö–¶–ò–ò ===
    let debugLogs = [];
    
    function addDebugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const log = `[${timestamp}] ${message}`;
      debugLogs.push({message: log, type: type});
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ª–æ–≥–∏
      if (debugLogs.length > 20) {
        debugLogs = debugLogs.slice(-20);
      }
      
      updateDebugPanel();
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function updateDebugPanel() {
      const panel = document.getElementById('debugPanel');
      if (!panel) return;
      
      let html = '<strong>Debug Logs:</strong><br><br>';
      debugLogs.forEach(log => {
        const cls = log.type === 'error' ? 'debug-error' : 
                   log.type === 'success' ? 'debug-success' : 'debug-log';
        html += `<div class="${cls}">${log.message}</div>`;
      });
      
      panel.innerHTML = html;
      panel.scrollTop = panel.scrollHeight;
    }
    
    function toggleDebugPanel() {
      const panel = document.getElementById('debugPanel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–±–∞–≥ –∫–Ω–æ–ø–∫–∏
    document.getElementById('debugToggle').addEventListener('click', toggleDebugPanel);
    addDebugLog('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');

    // === –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    const rotateScreen = document.getElementById('rotateScreen');
    const mainInterface = document.getElementById('mainInterface');
    const tabsPanel = document.getElementById('tabsPanel');
    const videoContainer = document.getElementById('videoContainer');
    const fieldContainer = document.getElementById('fieldContainer');
    const videoFrame = document.getElementById('videoFrame');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fieldImage = document.getElementById('fieldImage');
    const fieldInstruction = document.getElementById('fieldInstruction');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const recordingTimer = document.getElementById('recordingTimer');
    const choiceModal = document.getElementById('choiceModal');
    const goalBtn = document.getElementById('goalBtn');
    const saveBtn = document.getElementById('saveBtn');
    const currentTabTitle = document.getElementById('currentTabTitle');
    const tempInfo = document.getElementById('tempInfo');
    const shotInfo = document.getElementById('shotInfo');
    const tabs = document.querySelectorAll('.tab');

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let isRecording = false;
    let recordingStartTime = null;
    let timerInterval = null;
    let currentTab = 'video';
    let currentMarker = null;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let markerStartX = 0;
    let markerStartY = 0;
    let videoCurrentTime = 0;
    let isVideoPaused = false;
    let isImageLoaded = false;
    let lastShotData = null;

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–¥–ª—è –ø–æ–ª–æ–≤–∏–Ω—ã –ø–æ–ª—è - –ö–∞–Ω–∞–¥—Å–∫–æ–µ –ø–æ–ª–µ)
    const ORIGINAL_IMAGE_WIDTH = 484;    // –®–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (26 –º–µ—Ç—Ä–æ–≤)
    const ORIGINAL_IMAGE_HEIGHT = 432;   // –í—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (30 –º–µ—Ç—Ä–æ–≤)
    const ORIGINAL_GOAL_COORDS = { x: 244, y: 371 };  // –¶–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç
    const RINK_WIDTH_METERS = 26;        // –®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è (–º–µ—Ç—Ä—ã)
    const RINK_LENGTH_METERS = 30;       // –î–ª–∏–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—ã –ø–æ–ª—è (–º–µ—Ç—Ä—ã)
    const GOAL_DISTANCE_FROM_BOARDS = 4; // –í–æ—Ä–æ—Ç–∞ –≤ 4 –º–µ—Ç—Ä–∞—Ö –æ—Ç –±–æ—Ä—Ç–∞

       let scaleFactor = 1;
    let currentGoalCoords = { x: 0, y: 0 };
    let pixelsPerMeterX = 0;
    let pixelsPerMeterY = 0;
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get('video');
    const matchId = urlParams.get('match_id') || 1;
    const date = urlParams.get('date') || '';
    const opponent = urlParams.get('opponent') || '';

    addDebugLog(`Match ID –∏–∑ URL: ${matchId}`);
    addDebugLog(`Telegram –¥–æ—Å—Ç—É–ø–µ–Ω: ${telegramAvailable ? '–î–∞' : '–ù–µ—Ç'}`);

    // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function checkOrientation() {
      const isLandscape = window.innerWidth > window.innerHeight;
      rotateScreen.style.display = isLandscape ? 'none' : 'flex';
      mainInterface.style.display = isLandscape ? 'block' : 'none';
      
      if (isLandscape) {
        setTimeout(updateGoalCoordinates, 100);
      }
    }

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
      if (recordingStartTime) {
        const elapsed = Date.now() - recordingStartTime;
        recordingTimer.textContent = formatTime(elapsed);
      }
    }

    function pauseYouTubeVideo() {
      try {
        if (videoFrame.contentWindow) {
          videoFrame.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        }
      } catch (e) {}
    }

    function switchTab(tabName) {
      currentTab = tabName;
      
      tabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      if (tabName === 'video') {
        videoContainer.classList.add('active-tab');
        fieldContainer.classList.remove('active-tab');
        currentTabTitle.textContent = 'üé• –í–∏–¥–µ–æ –º–∞—Ç—á–∞';
        if (isVideoPaused) pauseYouTubeVideo();
      } else {
        videoContainer.classList.remove('active-tab');
        fieldContainer.classList.add('active-tab');
        currentTabTitle.textContent = 'üèí –°—Ö–µ–º–∞ –ø–æ–ª—è';
        pauseYouTubeVideo();
        isVideoPaused = true;
        
        setTimeout(() => {
          if (!isImageLoaded) {
            waitForImageLoad();
          } else {
            updateGoalCoordinates();
          }
        }, 100);
      }
    }

    function waitForImageLoad() {
      if (fieldImage.complete && fieldImage.naturalWidth > 0) {
        handleImageLoaded();
      } else {
        fieldImage.addEventListener('load', handleImageLoaded);
      }
    }

    function handleImageLoaded() {
      isImageLoaded = true;
      updateGoalCoordinates();
    }

       function updateGoalCoordinates() {
  if (!isImageLoaded) return;
  
  const imageRect = fieldImage.getBoundingClientRect();
  
  scaleFactor = imageRect.width / ORIGINAL_IMAGE_WIDTH;
  
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–æ—Ä–æ—Ç –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (–±–µ–∑ offsetX/Y)
  currentGoalCoords = {
    x: ORIGINAL_GOAL_COORDS.x * scaleFactor,
    y: ORIGINAL_GOAL_COORDS.y * scaleFactor
  };
  
  pixelsPerMeterX = (ORIGINAL_IMAGE_WIDTH * scaleFactor) / RINK_WIDTH_METERS;
  pixelsPerMeterY = (ORIGINAL_IMAGE_HEIGHT * scaleFactor) / RINK_LENGTH_METERS;
  
  addDebugLog(`–í–æ—Ä–æ—Ç–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è): x=${currentGoalCoords.x.toFixed(1)}, y=${currentGoalCoords.y.toFixed(1)}`);
}

    function showTempMessage(message) {
      tempInfo.textContent = message;
      tempInfo.style.display = 'block';
      
      setTimeout(() => {
        tempInfo.style.display = 'none';
      }, 1500);
    }

    function showShotResult(eventType, distance, angle) {
      const eventName = eventType === 'goal' ? '–ì–æ–ª' : '–°—ç–π–≤';
      const eventColor = eventType === 'goal' ? 'shot-info-goal' : 'shot-info-save';
      
      shotInfo.innerHTML = `
        <div class="shot-info-header">‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
        <div class="shot-info-row">
          <span class="shot-info-label">–¢–∏–ø:</span>
          <span class="shot-info-value ${eventColor}">${eventName}</span>
        </div>
        <div class="shot-info-row">
          <span class="shot-info-label">–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span>
          <span class="shot-info-value">${distance.toFixed(2)} –º</span>
        </div>
        <div class="shot-info-row">
          <span class="shot-info-label">–£–≥–æ–ª:</span>
          <span class="shot-info-value">${angle.toFixed(1)}¬∞</span>
        </div>
        <div class="shot-info-footer">–°–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—á–µ–∑–Ω–µ—Ç —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥</div>
      `;
      
      shotInfo.style.display = 'block';
      
      setTimeout(() => {
        shotInfo.style.display = 'none';
      }, 6000);
    }

          function calculateDistanceAndAngle(shootPointX, shootPointY) {
      if (!scaleFactor) {
        return { distance: 0, angle: 0 };
      }
      
      const goalX = currentGoalCoords.x;
      const goalY = currentGoalCoords.y;
      
      // –†–∞–∑–Ω–∏—Ü–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
      const dx = goalX - shootPointX;
      const dy = goalY - shootPointY;
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–µ—Ç—Ä—ã —Å —É—á—ë—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∞ —ç–∫—Ä–∞–Ω–∞ (–∏–∑ updateGoalCoordinates)
      const dxMeters = dx / pixelsPerMeterX;
      const dyMeters = dy / pixelsPerMeterY;
      
      // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (—Ç–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞ –≤ –º–µ—Ç—Ä–∞—Ö)
      const distanceMeters = Math.sqrt(dxMeters * dxMeters + dyMeters * dyMeters);
      
      // –£–≥–æ–ª: 0¬∞ = –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –≤–æ—Ä–æ—Ç–∞–º–∏, +90¬∞ = —Å–ø—Ä–∞–≤–∞, -90¬∞ = —Å–ª–µ–≤–∞
      let angleRad = Math.atan2(dxMeters, dyMeters);
      let angleDeg = angleRad * (180 / Math.PI);
      
      // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞
      angleDeg = Math.round(angleDeg * 10) / 10;
      
      addDebugLog(`dx=${dx.toFixed(1)}px, dy=${dy.toFixed(1)}px`);
      addDebugLog(`dxMeters=${dxMeters.toFixed(2)}–º, dyMeters=${dyMeters.toFixed(2)}–º`);
      addDebugLog(`distance=${distanceMeters.toFixed(2)}–º, angle=${angleDeg.toFixed(1)}¬∞`);
      
      return {
        distance: Math.round(distanceMeters * 100) / 100,
        angle: angleDeg
      };
    }
    
    function createMarker(x, y) {
      if (currentMarker) {
        currentMarker.remove();
      }
      
      currentMarker = document.createElement('div');
      currentMarker.className = 'marker-point';
      currentMarker.style.left = x + 'px';
      currentMarker.style.top = y + 'px';
      
      currentMarker.addEventListener('mousedown', startDrag);
      currentMarker.addEventListener('touchstart', startDragTouch, { passive: false });
      
      fieldContainer.appendChild(currentMarker);
      
      const result = calculateDistanceAndAngle(x, y);
      lastShotData = {
        x: x,
        y: y,
        distance: result.distance,
        angle: result.angle
      };
      
      // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è (–±–µ–∑ –≤—ã–±–æ—Ä–∞ –≤–æ—Ä–æ—Ç)
      setTimeout(() => {
        choiceModal.classList.add('visible');
      }, 300);
    }

    function startDrag(e) {
      e.preventDefault();
      e.stopPropagation();
      isDragging = true;
      currentMarker.classList.add('dragging');
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
    }

    function startDragTouch(e) {
      if (e.touches.length !== 1) return;
      e.preventDefault();
      e.stopPropagation();
      isDragging = true;
      currentMarker.classList.add('dragging');
      const touch = e.touches[0];
      dragStartX = touch.clientX;
      dragStartY = touch.clientY;
      markerStartX = currentMarker.offsetLeft;
      markerStartY = currentMarker.offsetTop;
      document.addEventListener('touchmove', dragTouch, { passive: false });
      document.addEventListener('touchend', stopDragTouch);
    }

    function drag(e) {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      const deltaY = e.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      
      const result = calculateDistanceAndAngle(newX, newY);
      lastShotData = {
        x: newX,
        y: newY,
        distance: result.distance,
        angle: result.angle
      };
    }

    function dragTouch(e) {
      if (!isDragging || e.touches.length !== 1) return;
      e.preventDefault();
      const touch = e.touches[0];
      const deltaX = touch.clientX - dragStartX;
      const deltaY = touch.clientY - dragStartY;
      const newX = markerStartX + deltaX;
      const newY = markerStartY + deltaY;
      currentMarker.style.left = newX + 'px';
      currentMarker.style.top = newY + 'px';
      
      const result = calculateDistanceAndAngle(newX, newY);
      lastShotData = {
        x: newX,
        y: newY,
        distance: result.distance,
        angle: result.angle
      };
    }

    function stopDrag() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('mousemove', drag);
      document.removeEventListener('mouseup', stopDrag);
    }

    function stopDragTouch() {
      isDragging = false;
      if (currentMarker) currentMarker.classList.remove('dragging');
      document.removeEventListener('touchmove', dragTouch);
      document.removeEventListener('touchend', stopDragTouch);
    }

   function handleFieldClick(e) {
  if (e.target.classList.contains('marker-point')) return;
  
  const imageRect = fieldImage.getBoundingClientRect();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–ª–∏–∫ –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  if (e.clientX < imageRect.left || e.clientX > imageRect.right ||
      e.clientY < imageRect.top || e.clientY > imageRect.bottom) {
    return;
  }
  
  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!)
  const x = e.clientX - imageRect.left;
  const y = e.clientY - imageRect.top;
  
  createMarker(x, y);
}

    function handleFieldTouch(e) {
  if (e.touches.length !== 1) return;
  e.preventDefault();
  
  const touch = e.touches[0];
  const element = document.elementFromPoint(touch.clientX, touch.clientY);
  
  if (element && element.classList.contains('marker-point')) return;
  
  const imageRect = fieldImage.getBoundingClientRect();
  
  if (touch.clientX < imageRect.left || touch.clientX > imageRect.right ||
      touch.clientY < imageRect.top || touch.clientY > imageRect.bottom) {
    return;
  }
  
  const x = touch.clientX - imageRect.left;
  const y = touch.clientY - imageRect.top;
  
  createMarker(x, y);
}
    
    function startRecording() {
      if (isRecording) return;
      
      isRecording = true;
      recordingStartTime = Date.now();
      
      recordingIndicator.style.display = 'flex';
      recordingTimer.style.display = 'block';
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function stopRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      recordingIndicator.style.display = 'none';
      recordingTimer.style.display = 'none';
      
      pauseYouTubeVideo();
      isVideoPaused = true;
      
      tabsPanel.classList.add('visible');
      switchTab('field');
    }

    // === –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í TELEGRAM –ë–û–¢ ===
    function sendToTelegramBot(eventType, distance, angle, originalX, originalY) {
      addDebugLog(`üîÑ –ü—ã—Ç–∞—é—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞...`);
      addDebugLog(`–¢–∏–ø: ${eventType}, –î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${distance}, –£–≥–æ–ª: ${angle}`);
      
      if (!telegramAvailable) {
        addDebugLog('‚ùå Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω!', 'error');
        alert('‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞!');
        return false;
      }
      
      const timestamp = Date.now() - recordingStartTime;
      const videoTime = videoCurrentTime;
      
      const eventData = {
        action: 'save_event',
        event: {
            match_id: parseInt(matchId),
            event_type: eventType,
            type: eventType,
            timestamp: timestamp,
            video_time: videoTime,
            distance: parseFloat(distance.toFixed(2)),
            angle: parseFloat(angle.toFixed(1)),
            goal_type: 'half_rink',  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            original_x: parseFloat(originalX.toFixed(2)),
            original_y: parseFloat(originalY.toFixed(2))
        }
      };
      
      addDebugLog(`üì¶ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${JSON.stringify(eventData)}`);
      
      try {
        const jsonString = JSON.stringify(eventData);
        addDebugLog(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é JSON: ${jsonString}`);
        
        Telegram.WebApp.sendData(jsonString);
        addDebugLog('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Telegram.WebApp.sendData()', 'success');
        
        return true;
        
      } catch (error) {
        addDebugLog(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, 'error');
        return false;
      }
    }

    // === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –°–û–ë–´–¢–ò–Ø ===
    function handleChoice(type) {
      addDebugLog(`üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª: ${type}`);
      choiceModal.classList.remove('visible');
      
      let distance = 0;
      let angle = 0;
      let originalX = 0;
      let originalY = 0;
      
      if (lastShotData) {
        distance = lastShotData.distance;
        angle = lastShotData.angle;
        originalX = lastShotData.x;
        originalY = lastShotData.y;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      showShotResult(type, distance, angle);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
      const success = sendToTelegramBot(type, distance, angle, originalX, originalY);
      
      if (success) {
        addDebugLog('‚úÖ –°–æ–±—ã—Ç–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
      } else {
        addDebugLog('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ', 'error');
      }
      
      // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä
      if (currentMarker) {
        currentMarker.remove();
        currentMarker = null;
      }
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      fieldInstruction.textContent = '–û—Ç–º–µ—Ç—å—Ç–µ —Ç–æ—á–∫—É –±—Ä–æ—Å–∫–∞ –Ω–∞ –ø–æ–ª–µ';
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∏–¥–µ–æ
      switchTab('video');
      tabsPanel.classList.remove('visible');
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      isVideoPaused = false;
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    function init() {
      addDebugLog('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
      checkOrientation();
      window.addEventListener('resize', checkOrientation);
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
      if (videoUrl) {
        let finalUrl = videoUrl;
        if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
          let videoId;
          if (videoUrl.includes('youtu.be/')) {
            videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
          } else {
            videoId = videoUrl.split('v=')[1]?.split('&')[0];
          }
          if (videoId) {
            finalUrl = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&controls=1&enablejsapi=1`;
          }
        }
        videoFrame.src = finalUrl;
        addDebugLog(`üé¨ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${finalUrl}`);
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
      startBtn.addEventListener('click', startRecording);
      stopBtn.addEventListener('click', stopRecording);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª—è
      fieldContainer.addEventListener('click', handleFieldClick);
      fieldContainer.addEventListener('touchstart', handleFieldTouch, { passive: false });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      goalBtn.addEventListener('click', () => handleChoice('goal'));
      saveBtn.addEventListener('click', () => handleChoice('save'));
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ
      window.addEventListener('message', (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.event === 'onReady') {
            startBtn.disabled = false;
            addDebugLog('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ', 'success');
          }
          if (data.info && data.info.currentTime !== undefined) {
            videoCurrentTime = data.info.currentTime;
          }
        } catch (e) {}
      });
      
      // –§–æ–ª–±—ç–∫ –¥–ª—è –≤–∏–¥–µ–æ
      setTimeout(() => {
        startBtn.disabled = false;
        addDebugLog('‚úÖ –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'success');
      }, 3000);
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      fieldImage.onload = function() {
        addDebugLog('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
        isImageLoaded = true;
        updateGoalCoordinates();
      };
      
      fieldImage.onerror = function() {
        addDebugLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
        fieldInstruction.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—è';
        fieldInstruction.style.backgroundColor = 'rgba(198, 40, 40, 0.9)';
      };
      
      if (fieldImage.complete && fieldImage.naturalWidth > 0) {
        fieldImage.onload();
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
      window.addEventListener('resize', updateGoalCoordinates);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –ø–æ–ª–æ–≤–∏–Ω—ã –ø–æ–ª—è
      fieldInstruction.textContent = '–û—Ç–º–µ—Ç—å—Ç–µ —Ç–æ—á–∫—É –±—Ä–æ—Å–∫–∞ –Ω–∞ –ø–æ–ª–µ';
      
      addDebugLog('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    init();
  </script>
</body>
</html>





